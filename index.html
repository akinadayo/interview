<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>„Éá„Ç∂„Ç§„É≥ÊÄùËÄÉ„Ç§„É≥„Çø„Éì„É•„Éº„Ç≤„Éº„É†</title>
    
    <!-- 
    NOTE: This is a single HTML file application for easy deployment.
    Production warnings are expected and intentional:
    - Tailwind CDN is used instead of PostCSS for simplicity
    - Babel transformer is used for JSX without build step
    „Åì„Çå„ÅØÂçò‰∏ÄHTML„Éï„Ç°„Ç§„É´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„Åô„ÄÇÁ∞°Âçò„Å™„Éá„Éó„É≠„Ç§„ÅÆ„Åü„ÇÅ„ÄÅ
    Êú¨Áï™Áí∞Â¢É„Åß„ÅÆË≠¶Âëä„ÅØÊÑèÂõ≥ÁöÑ„Å™„ÇÇ„ÅÆ„Åß„Åô„ÄÇ
    -->
    
    <!-- Tailwind CSS (CDN for single-file deployment) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning for single-file deployment
        if (typeof window !== 'undefined' && window.console) {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && args[0].includes('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX (required for single-file deployment) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Shared Game Logic (inlined for single-file deployment) -->
    <script>
    (function (root, factory) {
      if (typeof module === 'object' && module.exports) {
        module.exports = factory();
      } else {
        root.GameLogic = factory();
      }
    })(typeof globalThis !== 'undefined' ? globalThis : this, function () {
      const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

      const defaultOptions = {
        mood: 'normal',
        difficulty: 'normal',
        challengeMode: null,
        currentMission: null,
        scoreHistory: []
      };

      function calculateScore(questionInput, previousContextInput = '', options = {}) {
        const question = (questionInput ?? '').toString();
        const previousContext = (previousContextInput ?? '').toString();
        const {
          mood,
          difficulty,
          challengeMode,
          currentMission,
          scoreHistory
        } = { ...defaultOptions, ...options };

        let breakdown = {
          depth: 0,
          empathy: 0,
          exploration: 0,
          context: 0,
          penalty: 0,
          bonus: 0,
          combo: 0
        };

        const whyCount = (question.match(/„Å™„Åú|„Å©„ÅÜ„Åó„Å¶|„Å©„ÅÜ„Å™„Å£„Å¶|ÂéüÂõ†|ÁêÜÁî±/g) || []).length;
        if (whyCount > 0) {
          breakdown.depth += Math.min(whyCount * 15, 30);
          if (question.includes('Êú¨ÂΩì„Å´') || question.includes('„Åù„ÇÇ„Åù„ÇÇ') || question.includes('Ê†πÊú¨')) {
            breakdown.depth += 15;
            breakdown.bonus += 10;
          }
        }

        if (Array.isArray(scoreHistory) && scoreHistory.length > 0) {
          const lastScore = scoreHistory[scoreHistory.length - 1];
          if (lastScore >= 70 && whyCount > 0) {
            breakdown.combo = 15;
          }
        }

        if (question.includes('ÂÖ∑‰ΩìÁöÑ') || question.includes('‰æã„Åà„Å∞') || question.includes('„Å©„Çì„Å™')) {
          breakdown.depth += 5;
        }

        if ((question.includes('ÊÑü„Åò') || question.includes('ÊÄù„ÅÑ') || question.includes('Ê∞óÊåÅ„Å°')) &&
            (question.includes('„Å™„Åú') || question.includes('„Å©„ÅÜ„Åó„Å¶'))) {
          breakdown.depth += 7;
        }

        const empathyWords = ['Â§ßÂ§â', 'Èõ£„Åó„ÅÑ', 'Ëæõ„ÅÑ', 'Â¨â„Åó„ÅÑ', 'Á¥†Êô¥„Çâ„Åó„ÅÑ'];
        const hasEmpathy = empathyWords.some(word => question.includes(word));
        if (hasEmpathy && previousContext) {
          breakdown.empathy += 8;
        } else if (hasEmpathy) {
          breakdown.empathy += 3;
        }

        if ((previousContext && question.includes('"')) || question.includes('„Äå')) {
          breakdown.empathy += 5;
        }

        const isClosedQuestion = question.includes('„Åß„Åô„ÅãÔºü') ||
          question.includes('„Åæ„Åô„ÅãÔºü') ||
          !!question.match(/„ÅØ„ÅÑ|„ÅÑ„ÅÑ„Åà|Yes|No/i);

        if (!isClosedQuestion) {
          if (question.includes('„Å©„ÅÆ„Çà„ÅÜ„Å´') || question.includes('„Å©„Çì„Å™') || question.includes('‰Ωï„Åå')) {
            breakdown.exploration += 10;
          } else {
            breakdown.exploration += 5;
          }
        }

        if (question.includes('„ÇÇ„Åó') || question.includes('‰ªÆ„Å´') || question.includes('„Åü„Å®„Åà„Å∞')) {
          breakdown.exploration += 6;
        }

        if ((question.includes('ÁêÜÊÉ≥') && question.includes('ÁèæÂÆü')) ||
            question.includes('„ÇÆ„É£„ÉÉ„Éó') ||
            question.includes('ÈÅï„ÅÑ')) {
          breakdown.exploration += 8;
        }

        if (previousContext) {
          const contextWords = previousContext.split(/[„ÄÅ„ÄÇÔºÅÔºü\s]+/).filter(w => w.length > 2);
          const usedContextWords = contextWords.filter(word => question.includes(word)).length;
          breakdown.context += Math.min(usedContextWords * 3, 10);
        }

        if (question.length > 70) {
          breakdown.penalty -= 12;
        }
        if (question.length < 15) {
          breakdown.penalty -= 15;
        }
        if (question.split('Ôºü').length > 2) {
          breakdown.penalty -= 20;
        }
        if (question.includes('„ÅØ„ÅÑ') || question.includes('„ÅÑ„ÅÑ„Åà')) {
          breakdown.penalty -= 18;
        }
        if (!question.includes('Ôºü')) {
          breakdown.penalty -= 5;
        }
        if (question.includes('„Åß„Åô„Çà„Å≠') || question.includes('„Åß„Åó„Çá„ÅÜÔºü')) {
          breakdown.penalty -= 15;
        }

        const moodMultiplier = {
          open: 1.2,
          normal: 1.0,
          guard: 0.6,
          close: 0.3
        };

        const difficultyMultiplier = {
          easy: 1.2,
          normal: 0.9,
          hard: 0.7,
          expert: 0.5
        };

        let score = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
        const difficultyFactor = difficultyMultiplier[difficulty] ?? difficultyMultiplier.normal;
        const moodFactor = moodMultiplier[mood] ?? moodMultiplier.normal;

        score *= difficultyFactor;
        if (challengeMode === 'noHint') {
          score *= 1.5;
        }
        if (currentMission === 'speedrun') {
          score *= 1.3;
        }

        score = Math.round(score * moodFactor);
        score = clamp(score, 15, 100);

        if (score > 80) {
          if (whyCount < 2 || !question.includes('„Å™„Åú')) {
            score = Math.min(score, 70);
          }
        }
        if (score > 90) {
          if (!question.includes('ÊÑüÊÉÖ') && !question.includes('‰ΩìÈ®ì') && !question.includes('„Å™„Åú')) {
            score = Math.min(score, 85);
          }
        }

        return { score, breakdown };
      }

      function deriveNextMood(currentMood = 'normal', scoreValue = 50) {
        let mood = currentMood;
        const score = Number.isFinite(scoreValue) ? scoreValue : 50;

        if (score >= 80) {
          if (mood === 'close') mood = 'normal';
          else if (mood === 'guard') mood = 'open';
          else mood = 'open';
        } else if (score >= 60) {
          if (mood === 'close') mood = 'guard';
          else if (mood === 'guard') mood = 'normal';
          else if (mood === 'normal') mood = 'open';
        } else if (score <= 30) {
          if (mood === 'open') mood = 'normal';
          else if (mood === 'normal') mood = 'guard';
          else mood = 'close';
        } else if (score <= 40) {
          if (mood === 'open') mood = 'normal';
          else if (mood === 'normal') mood = 'guard';
        }

        return mood;
      }

      function calculateRank(currentScore = 0, targetScore = 0, scoreHistory = []) {
        const percentage = targetScore > 0 ? (currentScore / targetScore) * 100 : 0;
        const avgScore = Array.isArray(scoreHistory) && scoreHistory.length > 0
          ? scoreHistory.reduce((sum, value) => sum + value, 0) / scoreHistory.length
          : 0;

        if (percentage >= 100 && avgScore >= 85) return 'SSS';
        if (percentage >= 95 && avgScore >= 80) return 'SS';
        if (percentage >= 90 && avgScore >= 75) return 'S';
        if (percentage >= 80 && avgScore >= 70) return 'A';
        if (percentage >= 70 && avgScore >= 60) return 'B';
        if (percentage >= 60 && avgScore >= 50) return 'C';
        if (percentage >= 50 && avgScore >= 40) return 'D';
        return 'E';
      }

      function getAnalysisData(messages = [], scoreHistory = [], insights = [], questionCount = 0) {
        const avgScore = Array.isArray(scoreHistory) && scoreHistory.length > 0
          ? Math.round(scoreHistory.reduce((sum, value) => sum + value, 0) / scoreHistory.length)
          : 0;

        const userMessages = Array.isArray(messages)
          ? messages.filter(m => m && m.type === 'user' && typeof m.content === 'string')
          : [];

        const whyQuestions = userMessages.filter(m => m.content.includes('„Å™„Åú')).length;
        const openQuestions = userMessages.filter(m => !m.content.includes('Ôºü')).length;

        const totalLength = userMessages.reduce((sum, m) => sum + m.content.length, 0);
        const denominator = Math.max(1, questionCount || userMessages.length);
        const avgLength = Math.round(totalLength / denominator);

        return {
          avgScore,
          whyQuestions,
          openQuestions,
          avgLength,
          totalInsights: Array.isArray(insights) ? insights.length : 0
        };
      }

      function generatePersonaForTopic(selectedTopic = '', options = {}) {
        const rng = typeof options.rng === 'function' ? options.rng : Math.random;
        const maleNames = ['Áî∞‰∏≠Â§™ÈÉé', 'Èà¥Êú®‰∏ÄÈÉé', 'Ê∏°Ëæ∫ÂÅ•', 'Â±±Áî∞Â§ßËºî', 'Âä†Ëó§ÈõÑ‰ªã', 'Â∞èÊûóÁøî'];
        const femaleNames = ['‰ΩêËó§Ëä±Â≠ê', 'È´òÊ©ãÁæéÂí≤', '‰ºäËó§„Åï„Åè„Çâ', 'Â±±Êú¨ÊÑõ', '‰∏≠ÊùëÁúüÁî±Áæé', 'Êú®ÊùëÂÑ™Â≠ê'];

        let personaConfig = {
          ages: [25, 32, 28, 45, 38, 52, 35, 29, 41],
          jobs: ['„Ç®„É≥„Ç∏„Éã„Ç¢', '„Éá„Ç∂„Ç§„Éä„Éº', 'Âñ∂Ê•≠ËÅ∑', '„Éû„Éº„Ç±„Çø„Éº', 'ÊïôÂ∏´', 'ÂåªÁôÇÂæì‰∫ãËÄÖ', 'ÁµåÂñ∂ËÄÖ', '„Éï„É™„Éº„É©„É≥„Çπ', 'ÂÖ¨ÂãôÂì°'],
          locations: ['Êù±‰∫¨ÈÉΩÂøÉ', 'Á•ûÂ•àÂ∑ùÈÉäÂ§ñ', 'Âú∞ÊñπÈÉΩÂ∏Ç', 'Â§ßÈò™Â∏ÇÂÜÖ', 'Á¶èÂ≤°Â∏Ç'],
          families: ['Áã¨Ë∫´', 'Êó¢Â©öÔºàÂ≠ê‰æõ„Å™„ÅóÔºâ', 'Êó¢Â©öÔºàÂ≠ê‰æõ1‰∫∫Ôºâ', 'Êó¢Â©öÔºàÂ≠ê‰æõ2‰∫∫Ôºâ', '„Ç∑„É≥„Ç∞„É´ÔºàÂ≠ê‰æõ1‰∫∫Ôºâ'],
          hobbies: ['Ë™≠Êõ∏', 'Êò†ÁîªÈëëË≥û', '„Çπ„Éù„Éº„ÉÑ', 'ÊñôÁêÜ', 'ÊóÖË°å', '„Ç≤„Éº„É†', 'Èü≥Ê•Ω', '„Ç´„Éï„ÇßÂ∑°„Çä'],
          painPoints: [],
          hiddenNeeds: []
        };

        if (selectedTopic?.includes('Êúù') || selectedTopic?.includes('„É´„Éº„ÉÜ„Ç£„É≥')) {
          personaConfig = {
            ages: [28, 35, 42, 30, 45],
            jobs: ['‰ºöÁ§æÂì°', '„Ç®„É≥„Ç∏„Éã„Ç¢', 'Âñ∂Ê•≠ËÅ∑', '„Ç≥„É≥„Çµ„É´„Çø„É≥„Éà', 'ÁÆ°ÁêÜËÅ∑'],
            locations: ['Êù±‰∫¨ÈÉΩÂøÉ', 'Á•ûÂ•àÂ∑ùÈÉäÂ§ñ', 'ÂçÉËëâÈÉäÂ§ñ'],
            families: ['Êó¢Â©öÔºàÂ≠ê‰æõ1‰∫∫Ôºâ', 'Êó¢Â©öÔºàÂ≠ê‰æõ2‰∫∫Ôºâ', 'Áã¨Ë∫´', 'Êó¢Â©öÔºàÂ≠ê‰æõ„Å™„ÅóÔºâ'],
            hobbies: ['„Ç∏„Éß„ÇÆ„É≥„Ç∞', '„É®„Ç¨', 'Ë™≠Êõ∏', '„Ç≥„Éº„Éí„Éº', 'ÁûëÊÉ≥'],
            painPoints: ['ÊôÇÈñì‰∏çË∂≥', 'Ê∫ñÂÇô„ÅÆÈùûÂäπÁéá', 'ÂÆ∂Êóè„Å®„ÅÆË™øÊï¥'],
            hiddenNeeds: ['Ëá™ÂàÜÊôÇÈñì„ÅÆÁ¢∫‰øù', 'ÂäπÁéáÁöÑ„Å™ÊúùÊ¥ª', 'ÂÅ•Â∫∑ÁöÑ„Å™ÁøíÊÖ£']
          };
        } else if (selectedTopic?.includes('„É™„É¢„Éº„Éà') || selectedTopic?.includes('Âú®ÂÆÖ')) {
          personaConfig = {
            ages: [29, 35, 40, 32, 38],
            jobs: ['„Ç®„É≥„Ç∏„Éã„Ç¢', '„Éá„Ç∂„Ç§„Éä„Éº', '„Éû„Éº„Ç±„Çø„Éº', '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éû„Éç„Éº„Ç∏„É£„Éº', '„Éá„Éº„Çø„Ç¢„Éä„É™„Çπ„Éà'],
            locations: ['Êù±‰∫¨ÈÉäÂ§ñ', 'Âú∞ÊñπÈÉΩÂ∏Ç', 'Á•ûÂ•àÂ∑ùÁúå', 'ÂüºÁéâÁúå'],
            families: ['Êó¢Â©öÔºàÂ≠ê‰æõ1‰∫∫Ôºâ', 'Áã¨Ë∫´', 'Êó¢Â©öÔºàÂ≠ê‰æõ„Å™„ÅóÔºâ', '„Éö„ÉÉ„Éà„Å®ÂêåÂ±Ö'],
            hobbies: ['„Ç™„É≥„É©„Ç§„É≥„Ç≤„Éº„É†', 'ÂãïÁîªË¶ñËÅ¥', 'ÊñôÁêÜ', 'ÂúíËä∏', 'DIY'],
            painPoints: ['„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥‰∏çË∂≥', 'ÈÅãÂãï‰∏çË∂≥', '‰ªï‰∫ã„Å®„Éó„É©„Ç§„Éô„Éº„Éà„ÅÆÂ¢ÉÁïå'],
            hiddenNeeds: ['Á§æ‰ºöÁöÑ„Å§„Å™„Åå„Çä', 'ÂÅ•Â∫∑Á∂≠ÊåÅ', '„ÉØ„Éº„ÇØ„É©„Ç§„Éï„Éê„É©„É≥„Çπ']
          };
        } else if (selectedTopic?.includes('Ë≤∑„ÅÑÁâ©') || selectedTopic?.includes('Ë≥ºË≤∑')) {
          // Ë≤∑„ÅÑÁâ©„ÉªË≥ºË≤∑‰ΩìÈ®ì„Å´Èñ¢„Åô„Çã„Ç™„Éó„Ç∑„Éß„É≥
          options = {
            names: ['Â±±Áî∞Ëä±Â≠ê', 'Áî∞‰∏≠ÁæéÂí≤', 'Èà¥Êú®Áî±Áæé', '‰ΩêËó§„ÅÇ„ÇÜ„Åø'],
            ages: [28, 34, 42, 31],
            jobs: ['‰∫ãÂãôËÅ∑', '„Éë„Éº„ÉàÂã§Âãô', '„Éï„É™„Éº„É©„É≥„Çπ', '‰∏ªÂ©¶'],
            locations: ['Êù±‰∫¨ÈÉΩÂÜÖ', 'ÂçÉËëâÁúå', 'Á•ûÂ•àÂ∑ùÁúå'],
            families: ['Êó¢Â©öÔºàÂ≠ê‰æõ2‰∫∫Ôºâ', 'Áã¨Ë∫´', 'Êó¢Â©öÔºàÂ≠ê‰æõ„Å™„ÅóÔºâ'],
            hobbies: ['ÊñôÁêÜ', '„Éè„É≥„Éâ„É°„Ç§„Éâ', '„Ç´„Éï„ÇßÂ∑°„Çä', 'ÁØÄÁ¥Ñ'],
            painPoints: ['‰æ°Ê†ºÊØîËºÉ„ÅÆÊâãÈñì', 'Ë≤∑„ÅÑÁâ©ÊôÇÈñì„ÅÆÁ¢∫‰øù', '„Éç„ÉÉ„Éà vs ÂÆüÂ∫óËàó„ÅÆÈÅ∏Êäû'],
            hiddenNeeds: ['Ë≥¢„ÅÑË≤∑„ÅÑÁâ©', 'ÊôÇÈñìÂäπÁéá', 'Ê∫ÄË∂≥ÊÑü„ÅÆ„ÅÇ„ÇãË≥ºË≤∑‰ΩìÈ®ì']
          };
        }
        
        // „É©„É≥„ÉÄ„É†ÈÅ∏ÊäûÈñ¢Êï∞
        const random = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        return {
          name: random(options.names),
          gender: options.names[0].includes('Ëä±Â≠ê') || options.names[0].includes('ÁæéÂí≤') ? 'Â•≥ÊÄß' : 'Áî∑ÊÄß',
          age: random(options.ages),
          job: random(options.jobs),
          location: random(options.locations),
          family: random(options.families),
          hobbies: [random(options.hobbies), random(options.hobbies)].filter((v, i, a) => a.indexOf(v) === i),
          personality: {
            traits: ['Ë™†ÂÆü', 'Â•ΩÂ•áÂøÉÊó∫Áõõ', 'ÊÖéÈáç'],
            communication_style: '‰∏ÅÂØß„ÅßËêΩ„Å°ÁùÄ„ÅÑ„ÅüË©±„ÅóÊñπ'
          },
          background: `${selectedTopic}„Å´„Å§„ÅÑ„Å¶Êó•„ÄÖËÄÉ„Åà„Å¶„ÅÑ„Çã‰∏ÄËà¨ÁöÑ„Å™Á§æ‰ºö‰∫∫`,
          painPoints: options.painPoints,
          hiddenNeeds: options.hiddenNeeds,
          currentSituation: `${selectedTopic}„Å´„Å§„ÅÑ„Å¶„ÅÆÊîπÂñÑ„ÇíÊ®°Á¥¢‰∏≠`
        };
      }
      
      return {
        calculateScore,
        deriveNextMood,
        calculateRank,
        getAnalysisData,
        generatePersonaForTopic
      };
    });
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --keyboard-height: 0px;
            --vh: 1vh;
            --mobile-vh: 100vh;
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            width: 100%;
            height: 100%;
            /* position: fixed; ‚Üê ÂâäÈô§ */
            /* overflow: hidden; ‚Üê ÂâäÈô§ */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 20px rgba(99, 102, 241, 0.8); }
        }
        
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        .bounce {
            animation: bounce 1s infinite;
        }
        
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .glow {
            animation: glow 2s infinite;
        }
        
        .float-up {
            animation: floatUp 2s ease-out forwards;
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        .rainbow-bg {
            background: linear-gradient(90deg, #6366F1, #8B5CF6, #EC4899, #6366F1);
            background-size: 300% 100%;
            animation: rainbow 3s linear infinite;
        }
        
        /* „É™„ÉÉ„Éó„É´„Ç®„Éï„Çß„ÇØ„Éà */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            animation: ripple 0.6s ease-out;
        }
        
        /* „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥„ÉÜ„Ç≠„Çπ„Éà */
        .gradient-text {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* „Ç´„Éº„ÉâÂΩ± */
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .card-shadow-hover {
            transition: all 0.3s ease;
        }
        
        .card-shadow-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.06);
        }
        
        /* „É°„ÉÉ„Çª„Éº„Ç∏„Éê„Éñ„É´ - LINEÈ¢®„Éá„Ç∂„Ç§„É≥ */
        .message-bubble {
            position: relative;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message-bubble.user {
            background: #7CB342; /* LINEÈ¢®„ÅÆÁ∑ë */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-bubble.ai {
            background: white;
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº */
        .progress-bar {
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1e1b4b, #312e81);
            }
        }
        
        /* Mobile chat experience */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
                font-size: 14px;
                padding: 9px 13px;
                line-height: 1.5;
            }

            .mobile-chat-shell {
                position: fixed;
                inset: 0;
                display: flex;
                flex-direction: column;
                height: var(--mobile-vh, 100dvh);
                background: linear-gradient(160deg, #f3f4f6 0%, #dde8ff 100%);
                z-index: 1;
                overflow: hidden;
            }

            @supports (height: 100dvh) {
                .mobile-chat-shell {
                    height: 100dvh;
                }
            }

            @supports not (height: 100dvh) {
                .mobile-chat-shell {
                    height: calc(var(--vh, 1vh) * 100);
                }
            }

            .mobile-chat-header {
                flex: 0 0 auto;
                padding: calc(12px + env(safe-area-inset-top)) 18px 12px;
                background: rgba(255, 255, 255, 0.92);
                backdrop-filter: blur(14px);
                box-shadow: 0 1px 0 rgba(15, 23, 42, 0.05);
            }

            .mobile-chat-header-top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
            }

            .mobile-chat-title {
                font-size: 12px;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                color: #64748b;
            }

            .mobile-chat-score {
                font-size: 28px;
                font-weight: 700;
                color: #312e81;
                line-height: 1.1;
            }

            .mobile-header-actions {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .mobile-header-button {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 10px;
                font-size: 13px;
                font-weight: 600;
                background: #eef2ff;
                color: #4338ca;
                border-radius: 999px;
            }

            .mobile-chat-meta {
                display: flex;
                gap: 8px;
                margin-top: 14px;
                flex-wrap: wrap;
            }

            .mobile-chip {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 10px;
                background: rgba(148, 163, 184, 0.15);
                border-radius: 12px;
                font-size: 12px;
                color: #475569;
            }

            .mobile-chip strong {
                font-size: 13px;
                color: #0f172a;
            }

            .mobile-meter {
                margin-top: 12px;
            }

            .mobile-meter-label {
                font-size: 12px;
                color: #64748b;
                margin-bottom: 6px;
                display: inline-block;
            }

            .mobile-meter-track {
                position: relative;
                width: 100%;
                height: 8px;
                border-radius: 999px;
                background: rgba(148, 163, 184, 0.2);
                overflow: hidden;
            }

            .mobile-meter-fill {
                height: 100%;
                border-radius: inherit;
                background: linear-gradient(90deg, #6366f1, #ec4899);
                transition: width 0.3s ease;
            }

            .mobile-chat-scroll-wrapper {
                position: relative;
                flex: 1 1 auto;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .mobile-chat-scroll {
                flex: 1 1 auto;
                overflow-y: auto;
                padding: 20px 16px 88px;
                -webkit-overflow-scrolling: touch;
            }

            .mobile-chat-scroll::after {
                content: '';
                display: block;
                height: 1px;
                width: 100%;
            }

            .mobile-scroll-to-bottom {
                position: absolute;
                right: 16px;
                bottom: calc(84px + env(safe-area-inset-bottom));
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: linear-gradient(135deg, #6366f1, #ec4899);
                color: white;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 12px 24px rgba(99, 102, 241, 0.35);
            }

            .mobile-chat-compose {
                flex: 0 0 auto;
                padding: 12px 16px calc(16px + env(safe-area-inset-bottom));
                background: white;
                box-shadow: 0 -8px 24px rgba(15, 23, 42, 0.08);
            }

            .mobile-composer-fieldset {
                display: flex;
                align-items: flex-end;
                gap: 10px;
            }

            .mobile-composer-input {
                flex: 1;
                min-height: 48px;
                padding: 12px 16px;
                border: 1px solid rgba(148, 163, 184, 0.4);
                border-radius: 18px;
                background: rgba(248, 250, 252, 0.85);
                font-size: 16px;
                line-height: 1.4;
                -webkit-appearance: none;
                appearance: none;
            }

            .mobile-composer-input:focus {
                border-color: #6366f1;
                box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.18);
                background: #ffffff;
            }

            .mobile-send-button {
                flex: 0 0 auto;
                padding: 0 18px;
                min-height: 48px;
                border-radius: 16px;
                font-size: 15px;
                font-weight: 600;
                background: linear-gradient(135deg, #6366f1, #ec4899);
                color: #ffffff;
                box-shadow: 0 8px 18px rgba(236, 72, 153, 0.35);
            }

            .mobile-send-button:disabled {
                opacity: 0.5;
                box-shadow: none;
            }

            .mobile-combo-indicator {
                margin-top: 10px;
                text-align: center;
                font-size: 14px;
                font-weight: 700;
                color: #7c3aed;
            }

            .mobile-persona-modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 340px;
                background: white;
                border-radius: 16px;
                padding: 20px;
                z-index: 200;
                box-shadow: 0 25px 40px rgba(15, 23, 42, 0.25);
            }

            .mobile-persona-overlay {
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.55);
                z-index: 199;
            }

            input:focus,
            textarea:focus,
            select:focus {
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„ÉàÁî® */
        .particle {
            position: fixed;
            pointer-events: none;
            opacity: 0;
            animation: particle-float 3s ease-out forwards;
        }
        
        @keyframes particle-float {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(0);
            }
            50% {
                opacity: 1;
                transform: translate(var(--x), var(--y)) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(calc(var(--x) * 2), calc(var(--y) * 2)) scale(0.5);
            }
        }
        
        /* „Éà„Éº„Çπ„ÉàÈÄöÁü• */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease-out;
            z-index: 1000;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        
        // Safari/iOS compatible fetch helper
        const safariFetch = async (url, options, timeout = 15000) => {
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (isSafari || isIOS) {
                // For Safari/iOS, use Promise.race for timeout
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    )
                ]);
            } else {
                // For other browsers, use AbortController
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }
        };
        
        // „É°„Ç§„É≥„Ç¢„Éó„É™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        const InterviewGame = () => {
            // „Éá„Éê„Ç§„ÇπÊ§úÂá∫
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // „Ç≤„Éº„É†Áä∂ÊÖãÁÆ°ÁêÜ
            const [gameState, setGameState] = useState('menu'); // menu, persona, playing, result
            const [currentScore, setCurrentScore] = useState(0);
            const [difficulty, setDifficulty] = useState('normal'); // easy, normal, hard, expert
            const [questionCount, setQuestionCount] = useState(0);
            const [maxQuestions, setMaxQuestions] = useState(10);
            
            // „Çπ„Ç≥„Ç¢„Ç∑„Çπ„ÉÜ„É†ÔºàÊ∫ÄÁÇπ„Å™„Åó„ÄÅÁ¥îÁ≤ã„Å™Áç≤ÂæóÁÇπ„ÅÆ„ÅøÔºâ
            const [challengeMode, setChallengeMode] = useState(null); // null or specific challenge
            const [talkMeter, setTalkMeter] = useState(0);
            const [mood, setMood] = useState('normal'); // open, normal, guard, close
            const [messages, setMessages] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [scoreHistory, setScoreHistory] = useState([]);
            const [insights, setInsights] = useState([]);
            const [bestQuestions, setBestQuestions] = useState([]);
            const [comboCount, setComboCount] = useState(0);
            const [showParticles, setShowParticles] = useState(false);
            const [toasts, setToasts] = useState([]);
            const [achievements, setAchievements] = useState([]);
            const [totalGamesPlayed, setTotalGamesPlayed] = useState(
                parseInt(localStorage.getItem('totalGamesPlayed') || '0')
            );
            const [highScores, setHighScores] = useState(
                JSON.parse(localStorage.getItem('highScores') || '{}')
            );
            const [totalScore, setTotalScore] = useState(
                parseInt(localStorage.getItem('totalScore') || '0')
            );
            const [showDifficultySettings, setShowDifficultySettings] = useState(false);
            const [currentMission, setCurrentMission] = useState(null);
            const [isGeneratingPersona, setIsGeneratingPersona] = useState(false);
            const [showPersonaInfo, setShowPersonaInfo] = useState(false);
            
            // „Éö„É´„ÇΩ„ÉäË®≠ÂÆö
            const [persona, setPersona] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState('');
            const [painPoints, setPainPoints] = useState([]);
            const [selectedPainPoint, setSelectedPainPoint] = useState('');
            const [customPainPoint, setCustomPainPoint] = useState('');
            const [isGeneratingPainPoints, setIsGeneratingPainPoints] = useState(false);
            
            // APIË®≠ÂÆö
            const [apiKey, setApiKey] = useState(() => {
                if (typeof window === 'undefined') return '';
                try {
                    return localStorage.getItem('apiKey') || '';
                } catch (error) {
                    console.warn('Failed to read apiKey from storage:', error);
                    return '';
                }
            });
            const [apiModel, setApiModel] = useState(() => {
                if (typeof window === 'undefined') return 'deepseek/deepseek-chat-v3.1:free';
                try {
                    return localStorage.getItem('apiModel') || 'deepseek/deepseek-chat-v3.1:free';
                } catch (error) {
                    console.warn('Failed to read apiModel from storage:', error);
                    return 'deepseek/deepseek-chat-v3.1:free';
                }
            });
            const [showApiSettings, setShowApiSettings] = useState(false);
            const [apiTested, setApiTested] = useState(() => {
                if (typeof window === 'undefined') return false;
                try {
                    return localStorage.getItem('apiTested') === 'true';
                } catch (error) {
                    console.warn('Failed to read apiTested flag:', error);
                    return false;
                }
            });
            const [apiTesting, setApiTesting] = useState(false);
            const [isMobile, setIsMobile] = useState(false);
            
            const gameLogic = useMemo(() => window.GameLogic || null, []);

            // Refs
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const chatAreaRef = useRef(null);
            const initialViewportHeightRef = useRef(typeof window !== 'undefined' ? window.innerHeight : 0);

            // Show API settings on first load if no API key
            useEffect(() => {
                if (!apiKey && !localStorage.getItem('APIkey')) {
                    setShowApiSettings(true);
                }
            }, []); // Run only on mount
            
            useEffect(() => {
                if (typeof window === 'undefined') return;

                const updateMobileFlag = () => {
                    setIsMobile(window.innerWidth <= 768);
                    initialViewportHeightRef.current = window.innerHeight;
                    document.documentElement.style.setProperty('--mobile-vh', `${window.innerHeight}px`);
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };

                updateMobileFlag();

                window.addEventListener('resize', updateMobileFlag);
                window.addEventListener('orientationchange', updateMobileFlag);

                return () => {
                    window.removeEventListener('resize', updateMobileFlag);
                    window.removeEventListener('orientationchange', updateMobileFlag);
                };
            }, []);

            // Keep the mobile chat surface visible while the on-screen keyboard is open
            useEffect(() => {
                if (typeof window === 'undefined') return;

                if (!isMobile) {
                    document.documentElement.style.setProperty('--mobile-vh', `${window.innerHeight}px`);
                    document.documentElement.style.setProperty('--keyboard-height', '0px');
                    return;
                }

                const applyViewportSizing = () => {
                    const vv = window.visualViewport;
                    const height = vv ? vv.height : window.innerHeight;
                    document.documentElement.style.setProperty('--mobile-vh', `${height}px`);
                    document.documentElement.style.setProperty('--vh', `${height * 0.01}px`);

                    if (vv) {
                        const baseline = initialViewportHeightRef.current || window.innerHeight;
                        const inset = Math.max(baseline - (vv.height + (vv.offsetTop || 0)), 0);
                        const normalized = inset < 1 ? 0 : inset;
                        document.documentElement.style.setProperty('--keyboard-height', `${normalized}px`);
                    } else {
                        document.documentElement.style.setProperty('--keyboard-height', '0px');
                    }
                };

                const handleFocusIn = (event) => {
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        setTimeout(() => {
                            const area = chatAreaRef.current;
                            if (area) {
                                area.scrollTo({ top: area.scrollHeight, behavior: 'smooth' });
                            }
                        }, 80);
                    }
                };

                const handleFocusOut = () => {
                    setTimeout(applyViewportSizing, 120);
                };

                applyViewportSizing();

                const vv = window.visualViewport;
                vv?.addEventListener('resize', applyViewportSizing);
                vv?.addEventListener('scroll', applyViewportSizing);
                document.addEventListener('focusin', handleFocusIn);
                document.addEventListener('focusout', handleFocusOut);

                return () => {
                    vv?.removeEventListener('resize', applyViewportSizing);
                    vv?.removeEventListener('scroll', applyViewportSizing);
                    document.removeEventListener('focusin', handleFocusIn);
                    document.removeEventListener('focusout', handleFocusOut);
                };
            }, [isMobile, gameState]);

            useEffect(() => {
                if (typeof document === 'undefined') return;

                const html = document.documentElement;
                const body = document.body;
                const prevBodyOverflow = body.style.overflow;
                const prevHtmlOverflow = html.style.overflow;
                const prevOverscroll = html.style.overscrollBehavior;
                const prevTouchAction = html.style.touchAction;

                if (isMobile && gameState === 'playing') {
                    body.style.overflow = 'hidden';
                    html.style.overflow = 'hidden';
                    html.style.overscrollBehavior = 'contain';
                    html.style.touchAction = 'manipulation';
                } else {
                    body.style.overflow = '';
                    html.style.overflow = '';
                    html.style.overscrollBehavior = '';
                    html.style.touchAction = '';
                }

                return () => {
                    body.style.overflow = prevBodyOverflow;
                    html.style.overflow = prevHtmlOverflow;
                    html.style.overscrollBehavior = prevOverscroll;
                    html.style.touchAction = prevTouchAction;
                };
            }, [isMobile, gameState]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiKey', apiKey);
                } catch (error) {
                    console.warn('Failed to persist apiKey:', error);
                }
            }, [apiKey]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiModel', apiModel);
                } catch (error) {
                    console.warn('Failed to persist apiModel:', error);
                }
            }, [apiModel]);

            useEffect(() => {
                if (typeof window === 'undefined') return;
                try {
                    localStorage.setItem('apiTested', apiTested ? 'true' : 'false');
                } catch (error) {
                    console.warn('Failed to persist apiTested flag:', error);
                }
            }, [apiTested]);
            // „ÉÜ„Éº„Éû„Ç´„ÉÜ„Ç¥„É™„Éº
            const themeCategories = [
                { id: 'commute', title: 'ÈÄöÂã§„ÉªÁßªÂãï', icon: 'üöÉ' },
                { id: 'work', title: '‰ªï‰∫ã„ÉªÂ≠¶Áøí', icon: 'üíº' },
                { id: 'life', title: 'ÁîüÊ¥ª„ÉªÂÆ∂‰∫ã', icon: 'üè†' },
                { id: 'health', title: 'ÂÅ•Â∫∑„ÉªÈÅãÂãï', icon: 'üí™' },
                { id: 'social', title: '‰∫∫ÈñìÈñ¢‰øÇ', icon: 'üë•' },
                { id: 'hobby', title: 'Ë∂£Âë≥„ÉªÂ®ØÊ•Ω', icon: 'üéÆ' }
            ];
            
            // „Éö„Ç§„É≥„Éù„Ç§„É≥„ÉàÁîüÊàêÈñ¢Êï∞Ôºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
            const generatePainPoints = useCallback(async (category, retryCount = 0) => {
                if (!apiKey || !apiTested) {
                    showToast('API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return [];
                }
                
                const maxRetries = 2;
                
                // AIÁîüÊàê
                try {
                    const categoryInfo = themeCategories.find(c => c.id === category);
                    
                    // „Éá„Éê„ÉÉ„Ç∞: „É¢„Éá„É´Âêç„ÇíÁ¢∫Ë™ç
                    console.log('Generating scenario with model:', apiModel);
                    
                    // Sonoma Sky AlphaÁî®„Å´Ëã±Ë™û„Éó„É≠„É≥„Éó„Éà„Çí‰ΩøÁî®
                    const isSonoma = apiModel && apiModel.includes('sonoma');
                    
                    const prompt = isSonoma ? 
                        // English prompt for Sonoma Sky Alpha
                        `Generate 3 specific pain points that people commonly experience in the "${categoryInfo.title}" category.

Examples:
- Having difficulty taking buses
- Unable to handle stress in crowded trains
- Can't find the right timing to speak in online meetings

Respond with JSON:
{
  "painPoints": [
    "specific problem 1",
    "specific problem 2",
    "specific problem 3"
  ]
}` :
                        // Japanese prompt for DeepSeek models
                        `${categoryInfo.title}„Ç´„ÉÜ„Ç¥„É™„Éº„Åß„ÄÅ‰∏ÄËà¨ÁöÑ„Å™‰∫∫„ÅåÊä±„Åà„ÇãÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®Ôºà„Éö„Ç§„É≥„Éù„Ç§„É≥„ÉàÔºâ„Çí3„Å§ÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

‰æãÔºö
- „Éê„Çπ„Å´‰πó„Çã„ÅÆ„ÅåËã¶Êâã„ÅßÂõ∞„Å£„Å¶„ÅÑ„Çã
- Ê∫ÄÂì°ÈõªËªä„Åß„ÅÆ„Çπ„Éà„É¨„Çπ„ÅåËÄê„Åà„Çâ„Çå„Å™„ÅÑ
- „Ç™„É≥„É©„Ç§„É≥‰ºöË≠∞„ÅßÁô∫Ë®Ä„Åô„Çã„Çø„Ç§„Éü„É≥„Ç∞„ÅåÊé¥„ÇÅ„Å™„ÅÑ

‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂøúÁ≠î:
{
  "painPoints": [
    "ÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®1",
    "ÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®2",
    "ÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®3"
  ]
}`;

                    const systemPrompt = isSonoma ?
                        'You are a helpful assistant. Generate realistic pain points in Japanese. Respond only with valid JSON.' :
                        '„É™„Ç¢„É´„ÅßÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSONÂΩ¢Âºè„ÅßÂøúÁ≠î„ÄÇ';
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Pain Point Generation'
                        },
                        body: JSON.stringify({
                            model: apiModel || 'deepseek/deepseek-chat-v3.1:free',
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: prompt }
                            ],
                            temperature: isSonoma ? 0.5 : 0.8,
                            max_tokens: isSonoma ? 8000 : 2000 // Sonoma: 8000, DeepSeek: 2000
                        })
                    }, 20000); // 20 second timeout for Safari
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('API Error Response:', errorData);
                        console.error('Using model:', modelToUse);
                        throw new Error(`API request failed: ${response.status} - ${errorData}`);
                    }
                    
                    const data = await response.json();
                    if (!data.choices || !data.choices[0]) {
                        throw new Error('Invalid API response');
                    }
                    
                    const content = data.choices[0].message.content;
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        return parsed.painPoints || [];
                    }
                    return [];
                } catch (error) {
                    console.error(`Pain point generation error (attempt ${retryCount + 1}):`, error);
                    console.error('Model:', apiModel);
                    
                    // Sonoma Sky Alpha specific debugging
                    if (apiModel === 'openrouter/sonoma-sky-alpha') {
                        console.error('=== Sonoma Sky Alpha Debug Info ===');
                        console.error('Model name:', apiModel);
                        console.error('API Key present:', !!apiKey);
                        console.error('Error details:', error.message);
                        console.error('Full error:', error);
                        console.error('===================================');
                    }
                    
                    if (retryCount < maxRetries) {
                        console.log(`Retrying... (attempt ${retryCount + 2}/${maxRetries + 1})`);
                        showToast(`ÂÜçË©¶Ë°å‰∏≠... (${retryCount + 2}/${maxRetries + 1})`, 'info');
                        
                        // Wait a bit before retrying
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Recursive retry
                        return generatePainPoints(category, retryCount + 1);
                    }
                    
                    // All retries failed
                    const errorMsg = apiModel === 'openrouter/sonoma-sky-alpha'
                        ? 'Sonoma Sky Alpha„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ‰ªñ„ÅÆ„É¢„Éá„É´„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
                        : '„ÅäÈ°å„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                    showToast(errorMsg, 'error');
                    throw error;
                }
            }, [apiKey, apiModel, apiTested, showToast]);
            
            // AI„Éö„É´„ÇΩ„ÉäÁîüÊàêÊ©üËÉΩ
            const generatePersonaWithAI = useCallback(async (painPoint) => {
                if (!apiKey || !apiTested) {
                    showToast('AI„Éö„É´„ÇΩ„ÉäÁîüÊàê„Å´„ÅØAPIË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô', 'error');
                    return null;
                }
                
                try {
                    setIsGeneratingPersona(true);
                    showToast('AI„Åå„Éö„É´„ÇΩ„Éä„ÇíÁîüÊàê‰∏≠...', 'info');
                    
                    console.log('Generating persona with model:', apiModel);
                    
                    const promptText = `
‰ª•‰∏ã„ÅÆÂõ∞„Çä„Åî„Å®Ôºà„Éö„Ç§„É≥„Éù„Ç§„É≥„ÉàÔºâ„ÇíÊä±„Åà„Å¶„ÅÑ„ÇãÊû∂Á©∫„ÅÆ‰∫∫Áâ©Ôºà„Éö„É´„ÇΩ„ÉäÔºâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Éö„Ç§„É≥„Éù„Ç§„É≥„Éà: ${painPoint}

„É™„Ç¢„É´„ÅßËá™ÁÑ∂„Å™„Éö„É´„ÇΩ„Éä„Çí‰ΩúÊàê„Åó„ÄÅÂøÖ„ÅöÂÆåÂÖ®„Å™ÊúâÂäπ„Å™JSONÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÊñáÁ´†„ÅØÁü≠„Åè„Åæ„Å®„ÇÅ„ÄÅJSON„ÅåÈÄî‰∏≠„ÅßÂàá„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
{
  "name": "Êó•Êú¨‰∫∫„ÅÆÂêçÂâçÔºà„Éï„É´„Éç„Éº„É†Ôºâ",
  "gender": "Áî∑ÊÄß„Åæ„Åü„ÅØÂ•≥ÊÄß",
  "age": Âπ¥ÈΩ¢Ôºà20-60„ÅÆÊï¥Êï∞Ôºâ,
  "job": "ÂÖ∑‰ΩìÁöÑ„Å™ËÅ∑Ê•≠",
  "location": "ÂÖ∑‰ΩìÁöÑ„Å™Â±Ö‰ΩèÂú∞ÔºàÈÉΩÂ∏ÇÂêç„ÇÑÂú∞ÂüüÔºâ",
  "family": "ÂÆ∂ÊóèÊßãÊàêÔºàÁã¨Ë∫´„ÄÅÊó¢Â©ö„Å™„Å©ÂÖ∑‰ΩìÁöÑ„Å´Ôºâ",
  "hobbies": ["Ë∂£Âë≥1", "Ë∂£Âë≥2"],
  "personality": {
    "traits": ["ÊÄßÊ†ºÁâπÊÄß1", "ÊÄßÊ†ºÁâπÊÄß2", "ÊÄßÊ†ºÁâπÊÄß3"],
    "communication_style": "„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥„Çπ„Çø„Ç§„É´"
  },
  "background": "ËÉåÊôØÔºà1-2Êñá„ÅßÁ∞°ÊΩî„Å´Ôºâ",
  "painPoints": ["Ë™≤È°å1", "Ë™≤È°å2", "Ë™≤È°å3"],
  "hiddenNeeds": ["„Éã„Éº„Ç∫1", "„Éã„Éº„Ç∫2"],
  "currentSituation": "ÁèæÁä∂Ôºà1-2Êñá„ÅßÁ∞°ÊΩî„Å´Ôºâ"
}

ÈáçË¶ÅÔºö
- ‰∏é„Åà„Çâ„Çå„Åü„Éö„Ç§„É≥„Éù„Ç§„É≥„Éà„ÇíÂøÖ„Åö‰∏ªË¶Å„Å™ÊÇ©„Åø„Å®„Åó„Å¶Âê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ
- painPointsÔºàË™≤È°åÔºâ„ÅÆ1„Å§ÁõÆ„ÅØÂøÖ„Åö„Äå${painPoint}„Äç„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- ÊÆã„Çä2„Å§„ÅØÈñ¢ÈÄ£„Åô„ÇãÂÖ∑‰ΩìÁöÑ„Å™ÂïèÈ°å„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- hiddenNeedsÔºàÈö†„Çå„Åü„Éã„Éº„Ç∫Ôºâ„ÅØ„Åì„ÅÆ„Éö„Ç§„É≥„Éù„Ç§„É≥„Éà„ÇíËß£Ê±∫„Åó„Åü„ÅÑÊú¨ÂΩì„ÅÆÁêÜÁî±„Çí2„Å§Êåô„Åí„Å¶„Åè„Å†„Åï„ÅÑ
- „Éö„É´„ÇΩ„Éä„ÅØ„Åì„ÅÆ„Éö„Ç§„É≥„Éù„Ç§„É≥„Éà„Å´ÂÆüÈöõ„Å´Âõ∞„Å£„Å¶„ÅÑ„Çã‰∫∫„Å®„Åó„Å¶ÊåØ„ÇãËàû„ÅÑ„Åæ„Åô
- ÁüõÁõæ„Åó„ÅüÂõûÁ≠îÔºà‰æãÔºöÂõ∞„Å£„Å¶„ÅÑ„Çã„ÅÆ„Å´„ÄåÂïèÈ°å„Å™„ÅÑ„Äç„Å®Á≠î„Åà„ÇãÔºâ„ÅØÁµ∂ÂØæ„Å´„Åó„Åæ„Åõ„Çì`;
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { 
                                    role: 'system', 
                                    content: '„ÅÇ„Å™„Åü„ÅØ„Éö„É´„ÇΩ„Éä‰ΩúÊàê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ„É™„Ç¢„É´„ÅßË©≥Á¥∞„Å™‰∫∫Áâ©Ë®≠ÂÆö„Çí‰ΩúÊàê„Åó„ÄÅÂøÖ„ÅöJSONÂΩ¢Âºè„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' 
                                },
                                { role: 'user', content: promptText }
                            ],
                            temperature: 0.9,
                            max_tokens: apiModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 3000 // Sonoma: 8000, DeepSeek: 3000
                        })
                    }, 20000);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid API response structure');
                    }
                    
                    const content = data.choices[0].message.content || '';
                    
                    // Á©∫„ÅÆÂøúÁ≠î„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!content || content.trim().length < 10) {
                        console.log('Empty or too short API response, using fallback');
                        throw new Error('Empty API response');
                    }
                    
                    // JSON„Éë„Éº„ÇπË©¶Ë°åÔºàÊîπÂñÑÁâàÔºâ
                    let parsedPersona;
                    try {
                        // JSON„Éñ„É≠„ÉÉ„ÇØ„ÇíÊäΩÂá∫
                        let jsonStr = content;
                        
                        // „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÇíÈô§Âéª
                        if (content.includes('```json')) {
                            const match = content.match(/```json\n?([\s\S]*?)\n?```/);
                            if (match) jsonStr = match[1];
                        } else if (content.includes('```')) {
                            const match = content.match(/```\n?([\s\S]*?)\n?```/);
                            if (match) jsonStr = match[1];
                        }
                        
                        // ‰∏çÂÆåÂÖ®„Å™JSON„ÇíÊ§úÂá∫„Åó„Å¶‰øÆÂæ©
                        if (!jsonStr.trim().endsWith('}')) {
                            console.log('Incomplete JSON detected, attempting to fix...');
                            
                            // ÊúÄÂæå„ÅÆÂÆåÂÖ®„Å™„Éó„É≠„Éë„ÉÜ„Ç£„Åæ„Åß„ÅßÂàá„Çã
                            const lines = jsonStr.split('\n');
                            let lastValidLine = -1;
                            
                            for (let i = lines.length - 1; i >= 0; i--) {
                                const line = lines[i].trim();
                                if (line.endsWith(',') || line.endsWith('}') || line.endsWith(']')) {
                                    lastValidLine = i;
                                    break;
                                }
                            }
                            
                            if (lastValidLine >= 0) {
                                jsonStr = lines.slice(0, lastValidLine + 1).join('\n');
                                // ÊúÄÂæå„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                                if (jsonStr.trim().endsWith(',')) {
                                    jsonStr = jsonStr.trim().slice(0, -1);
                                }
                            }
                            
                            // Èñã„ÅÑ„Å¶„ÅÑ„Çã„Éñ„É©„Ç±„ÉÉ„Éà„ÇíÊï∞„Åà„Çã
                            const openBraces = (jsonStr.match(/\{/g) || []).length;
                            const closeBraces = (jsonStr.match(/\}/g) || []).length;
                            const openBrackets = (jsonStr.match(/\[/g) || []).length;
                            const closeBrackets = (jsonStr.match(/\]/g) || []).length;
                            
                            // ‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÈñâ„ÅòÊã¨Âºß„ÇíËøΩÂä†
                            for (let i = 0; i < openBrackets - closeBrackets; i++) {
                                jsonStr += ']';
                            }
                            
                            // ‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÈñâ„ÅòÊ≥¢Êã¨Âºß„ÇíËøΩÂä†
                            for (let i = 0; i < openBraces - closeBraces; i++) {
                                jsonStr += '}';
                            }
                        }
                        
                        // JSON„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊäΩÂá∫
                        const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            jsonStr = jsonMatch[0];
                        }
                        
                        // „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„ÅüÂºïÁî®Á¨¶„Çí‰øÆÊ≠£ÔºàÊúÄÂàù„Å´Âá¶ÁêÜÔºâ
                        jsonStr = jsonStr.replace(/\\"/g, '"');
                        
                        // ‰∏ÄËà¨ÁöÑ„Å™JSONÂΩ¢Âºè„Ç®„É©„Éº„Çí‰øÆÊ≠£
                        jsonStr = jsonStr
                            .replace(/,\s*}/g, '}')  // Êú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                            .replace(/,\s*]/g, ']')  // ÈÖçÂàóÊú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                            .replace(/"\s*:\s*"([^"]*)"([^,}\]]*[,}\]])/g, '": "$1"$2')  // „Ç≥„É≠„É≥Âæå„ÅÆ„Çπ„Éö„Éº„Çπ„Çí‰øÆÊ≠£
                            .replace(/\n\s*\n/g, '\n')  // ‰ΩôÂàÜ„Å™ÊîπË°å„ÇíÂâäÈô§
                            .replace(/,(\s*[}\]])/g, '$1'); // ÊúÄÂæå„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                        
                        console.log('Attempting to parse JSON:', jsonStr.substring(0, 500) + '...');
                        parsedPersona = JSON.parse(jsonStr);
                        
                    } catch (e) {
                        console.error('Persona JSON Parse Error:', e, '\nContent:', content);
                        
                        // „Éë„Éº„Çπ„Ç®„É©„ÉºÊôÇ„ÅØÂü∫Êú¨ÁöÑ„Å™„Éö„É´„ÇΩ„Éä„Çí‰ΩúÊàê
                        parsedPersona = {
                            name: 'Â±±Áî∞Â§™ÈÉé',
                            gender: 'Áî∑ÊÄß',
                            age: 35,
                            job: '‰ºöÁ§æÂì°',
                            location: 'Êù±‰∫¨ÈÉΩ',
                            family: 'Êó¢Â©öÔºàÂ≠ê‰æõ1‰∫∫Ôºâ',
                            hobbies: ['Ë™≠Êõ∏', 'Êï£Ê≠©'],
                            personality: {
                                traits: ['ÁúüÈù¢ÁõÆ', 'ÂçîË™øÁöÑ', 'ÊÖéÈáç'],
                                communication_style: '‰∏ÅÂØß„ÅßËêΩ„Å°ÁùÄ„ÅÑ„ÅüË©±„ÅóÊñπ'
                            },
                            background: `${painPoint}„ÅßÂõ∞„Å£„Å¶„ÅÑ„ÇãÁ§æ‰ºö‰∫∫„Åß„Åô„ÄÇ`,
                            painPoints: [painPoint, 'ÊôÇÈñì‰∏çË∂≥', '„Çπ„Éà„É¨„Çπ'],
                            hiddenNeeds: ['ÂïèÈ°åËß£Ê±∫', 'Âø´ÈÅ©„Å™ÁîüÊ¥ª'],
                            currentSituation: `ÁèæÂú®„ÄÅ${painPoint}„Å®„ÅÑ„ÅÜË™≤È°å„ÇíËß£Ê±∫„Åó„Åü„ÅÑ„Å®ËÄÉ„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
                        };
                        
                        console.log('Using fallback persona due to parse error');
                    }
                    
                    // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆÁ¢∫Ë™ç„Å®„Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
                    const persona = {
                        name: parsedPersona.name || 'Áî∞‰∏≠Â§™ÈÉé',
                        gender: parsedPersona.gender || 'Áî∑ÊÄß',
                        age: parsedPersona.age || 35,
                        job: parsedPersona.job || '‰ºöÁ§æÂì°',
                        location: parsedPersona.location || 'Êù±‰∫¨ÈÉΩ',
                        family: parsedPersona.family || 'Áã¨Ë∫´',
                        hobbies: parsedPersona.hobbies || ['Ë™≠Êõ∏', 'Êò†ÁîªÈëëË≥û'],
                        personality: {
                            openness: Math.random(),
                            empathy: Math.random(),
                            guardedness: Math.random(),
                            traits: parsedPersona.personality?.traits || [],
                            communication_style: parsedPersona.personality?.communication_style || 'ÊôÆÈÄö'
                        },
                        background: parsedPersona.background || '',
                        painPoints: parsedPersona.painPoints || [],
                        hiddenNeeds: parsedPersona.hiddenNeeds || [],
                        currentSituation: parsedPersona.currentSituation || '',
                        currentMood: 'normal'
                    };
                    
                    // AIÁîüÊàêÊàêÂäü„ÅÆÂ†¥Âêà„ÅØ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                    if (parsedPersona && parsedPersona.name && parsedPersona.name !== 'Â±±Áî∞Â§™ÈÉé') {
                        showToast('AI„Éö„É´„ÇΩ„Éä„ÅÆÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    } else {
                        showToast('AI„Éö„É´„ÇΩ„Éä„ÇíÁ∞°ÊòìÁîüÊàê„Åó„Åæ„Åó„Åü', 'info');
                    }
                    
                    return persona;
                    
                } catch (error) {
                    console.error('AI Persona Generation Error:', error);
                    showToast('AI„Éö„É´„ÇΩ„ÉäÁîüÊàê„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂü∫Êú¨„Éö„É´„ÇΩ„Éä„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ', 'warning');
                    
                    // „Ç®„É©„ÉºÊôÇ„ÇÇÂü∫Êú¨ÁöÑ„Å™„Éö„É´„ÇΩ„Éä„ÇíËøî„Åô
                    const fallbackPainPoint = '„Ç§„É≥„Çø„Éì„É•„Éº„ÅåËã¶Êâã„ÅßÂõ∞„Å£„Å¶„ÅÑ„Çã';
                    return {
                        name: 'Èà¥Êú®Ëä±Â≠ê',
                        gender: 'Â•≥ÊÄß',
                        age: 30,
                        job: '‰ºöÁ§æÂì°',
                        location: 'Êù±‰∫¨ÈÉΩ',
                        family: 'Áã¨Ë∫´',
                        hobbies: ['„Ç´„Éï„ÇßÂ∑°„Çä', 'Ë™≠Êõ∏'],
                        personality: {
                            openness: 0.7,
                            empathy: 0.8,
                            guardedness: 0.3,
                            traits: ['Á§æ‰∫§ÁöÑ', 'Â•ΩÂ•áÂøÉÊó∫Áõõ', 'ÂâçÂêë„Åç'],
                            communication_style: 'Ë¶™„Åó„Åø„ÇÑ„Åô„ÅÑË©±„ÅóÊñπ'
                        },
                        background: `ÈÉΩÂÜÖ„ÅßÂÉç„Åè‰ºöÁ§æÂì°„Åß„Åô„ÄÇ${fallbackPainPoint}`,
                        painPoints: [fallbackPainPoint, 'ÊôÇÈñìÁÆ°ÁêÜ', '„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥‰∏çË∂≥'],
                        hiddenNeeds: ['Ëá™‰ø°„ÇíÊåÅ„Å°„Åü„ÅÑ', 'ÂäπÊûúÁöÑ„Å™Ë≥™Âïè„Çπ„Ç≠„É´'],
                        currentSituation: `${fallbackPainPoint}„Å®„ÅÑ„ÅÜÁä∂Ê≥Å„ÇíÊîπÂñÑ„Åó„Åü„ÅÑ„Å®ÊÄù„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ`,
                        currentMood: 'normal'
                    };
                } finally {
                    setIsGeneratingPersona(false);
                }
            }, [apiKey, apiModel, apiTested, showToast, generatePersona]);
            
            // „Éö„É´„ÇΩ„ÉäÁîüÊàêÔºàÊâãÂãï„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            const generatePersona = useCallback((painPoint) => {
                // „Éö„Ç§„É≥„Éù„Ç§„É≥„Éà„Å´Âü∫„Å•„ÅÑ„Åü„Éá„Éï„Ç©„É´„Éà„Éö„É´„ÇΩ„Éä„ÇíÁîüÊàê
                return {
                    name: 'Â±±Áî∞Â§™ÈÉé',
                    gender: 'Áî∑ÊÄß',
                    age: 35,
                    job: '‰ºöÁ§æÂì°',
                    location: 'Êù±‰∫¨ÈÉΩ',
                    family: 'Áã¨Ë∫´',
                    hobbies: ['Ë™≠Êõ∏', 'Êò†ÁîªÈëëË≥û'],
                    personality: {
                        openness: 0.5,
                        empathy: 0.5,
                        guardedness: 0.5
                    },
                    hiddenNeeds: ['„Çπ„Éà„É¨„Çπ„Éï„É™„Éº„Å™ÁîüÊ¥ª', 'ÂäπÁéáÁöÑ„Å™Ëß£Ê±∫Á≠ñ'],
                    painPoints: [painPoint, 'ÊôÇÈñìÁöÑ‰ΩôË£ï„ÅÆ„Å™„Åï', '„Çπ„Éà„É¨„Çπ„ÅÆËìÑÁ©ç'],
                    currentMood: 'normal',
                    background: `${painPoint}„ÅßÊó•„ÄÖÂõ∞„Å£„Å¶„ÅÑ„Çã‰ºöÁ§æÂì°`,
                    currentSituation: `${painPoint}„Çí„Å©„ÅÜ„Å´„ÅãËß£Ê±∫„Åó„Åü„ÅÑ„Å®ÊÄù„Å£„Å¶„ÅÑ„Çã`
                };
            }, [gameLogic]);
            
            // „Çπ„Ç≥„Ç¢Ë®àÁÆóÔºàÊîπÂñÑÁâà - ÂÖ±ÈÄö„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂà©Áî®Ôºâ
            const calculateScore = useCallback((question, previousContext) => {
                if (gameLogic?.calculateScore) {
                    return gameLogic.calculateScore(question, previousContext, {
                        mood,
                        difficulty,
                        challengeMode,
                        currentMission,
                        scoreHistory
                    });
                }
                return {
                    score: 50,
                    breakdown: {
                        depth: 0,
                        empathy: 0,
                        exploration: 0,
                        context: 0,
                        penalty: 0,
                        bonus: 0,
                        combo: 0
                    }
                };
            }, [gameLogic, mood, difficulty, challengeMode, currentMission, scoreHistory]);
            
            // API„ÉÜ„Çπ„ÉàÊ©üËÉΩ
            const testAPI = useCallback(async () => {
                if (!apiKey) {
                    showToast('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return false;
                }
                
                setApiTesting(true);
                try {
                    const requestBody = {
                        model: apiModel,
                        messages: [
                            { role: 'user', content: '„ÉÜ„Çπ„ÉàÊé•Á∂ö„Åß„Åô„ÄÇÁ∞°ÊΩî„Å´ÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' }
                        ],
                        max_tokens: 100,
                        temperature: 0.7
                    };
                    
                    console.log('Testing API with model:', apiModel);
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify(requestBody)
                    }, 10000);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMsg = `API Error: ${response.status}`;
                        
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMsg = errorJson.error?.message || errorMsg;
                        } catch {
                            errorMsg = errorText || errorMsg;
                        }
                        
                        // Sonoma Sky Alpha specific error handling
                        if (apiModel === 'openrouter/sonoma-sky-alpha') {
                            console.error('=== Sonoma Sky Alpha Connection Failed ===');
                            console.error('Status:', response.status);
                            console.error('Error:', errorMsg);
                            console.error('Headers:', response.headers);
                            
                            if (response.status === 403 || response.status === 401) {
                                errorMsg = 'Sonoma Sky Alpha„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇAPI„Ç≠„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            } else if (response.status === 404) {
                                errorMsg = 'Sonoma Sky Alpha„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
                            }
                        }
                        
                        throw new Error(errorMsg);
                    }
                    
                    const data = await response.json();
                    if (data.choices && data.choices[0]) {
                        setApiTested(true);
                        showToast('APIÊé•Á∂öÊàêÂäüÔºÅ„Ç≤„Éº„É†„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô', 'success');
                        return true;
                    }
                    throw new Error('Invalid API response');
                    
                } catch (error) {
                    console.error('API Test Error:', error);
                    
                    // Sonoma Sky Alpha fallback suggestion
                    if (apiModel === 'openrouter/sonoma-sky-alpha') {
                        setApiTested(false);
                        showToast('Sonoma Sky Alpha„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇDeepSeek„É¢„Éá„É´„ÅÆ‰ΩøÁî®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ', 'error');
                        
                        // Suggest switching to DeepSeek
                        setTimeout(() => {
                            if (window.confirm('DeepSeek Chat V3.1„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÅãÔºü')) {
                                setApiModel('deepseek/deepseek-chat-v3.1:free');
                                showToast('DeepSeek Chat V3.1„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'info');
                            }
                        }, 500);
                    } else {
                        setApiTested(false);
                        showToast(`APIÊé•Á∂öÂ§±Êïó: ${error.message}`, 'error');
                    }
                    return false;
                } finally {
                    setApiTesting(false);
                }
            }, [apiKey, apiModel, showToast]);
            
            // AIÂøúÁ≠îÁîüÊàê
            const generateAIResponse = useCallback(async (question) => {
                setIsTyping(true);

                // API„Ç≠„Éº„Åå„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„ÉÜ„Çπ„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Ç®„É©„Éº
                if (!apiKey || !apiTested) {
                    setIsTyping(false);
                    showToast('API„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆöÁîªÈù¢„ÅßAPI„Çí„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    return {
                        response: 'API„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
                        score: 0,
                        breakdown: {},
                        newMood: mood,
                        insight: null
                    };
                }
                
                console.log('Generating response with model:', apiModel);
                
                // OpenRouter APIÂëº„Å≥Âá∫„ÅóÔºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
                const maxRetries = 3;
                let retryCount = 0;
                let lastError = null;
                
                while (retryCount < maxRetries) {
                    try {
                        if (retryCount > 0) {
                            console.log(`Retry attempt ${retryCount} of ${maxRetries}`);
                            showToast(`ÂÜçË©¶Ë°å‰∏≠... (${retryCount}/${maxRetries})`, 'info');
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // Â¢óÂàÜÂæÖÊ©ü
                        }
                        
                        // „Éó„É≠„É≥„Éó„Éà„ÇíÁü≠„Åè„Åó„Å¶Á¢∫ÂÆü„Å´ÂøúÁ≠î„ÇíÂæó„Çã
                        const moodDescription = {
                            open: 'ÈñãÊîæÁöÑ„Åß„ÄÅÂâçÂêë„Åç„Å´Ë©±„Åó„Åü„Åå„Å£„Å¶„ÅÑ„Çã„ÄÇËß£Ê±∫„Å∏„ÅÆÊúüÂæÖ„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã',
                            normal: 'ÊôÆÈÄö„Å´‰ºöË©±„Åó„Å¶„ÅÑ„Çã„ÄÇÈÅ©Â∫¶„Å™ÂçîÂäõÂßøÂã¢',
                            guard: 'Â∞ë„ÅóË≠¶Êàí„Åó„Å¶„ÅÑ„Çã„Åå„ÄÅË©±„ÅôÊÑèÊ¨≤„ÅØ„ÅÇ„Çã',
                            close: 'ÂøÉ„ÇíÈñâ„Åñ„ÅóÊ∞óÂë≥„Å†„Åå„ÄÅËâØ„ÅÑË≥™Âïè„Å´„ÅØÂèçÂøú„Åó„Åü„ÅÑ'
                        };
                        
                        const conversationHistory = messages.slice(-4).map(m => 
                            `${m.type === 'user' ? '„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº' : persona.name}: ${m.content}`
                        ).join('\n');
                        
                        const promptText = `„ÅÇ„Å™„Åü„ÅØ${persona.name}Ôºà${persona.age}Ê≠≥„ÄÅ${persona.gender}Ôºâ„Åß„Åô„ÄÇ
ËÅ∑Ê•≠: ${persona.job}
Â†¥ÊâÄ: ${persona.location}
ÂÆ∂Êóè: ${persona.family}
Ë∂£Âë≥: ${persona.hobbies.join('„ÄÅ')}
ÊÇ©„Åø„ÉªË™≤È°å: ${persona.painPoints && persona.painPoints.length > 0 ? persona.painPoints.join('„ÄÅ') : 'Áâπ„Å´„Å™„Åó'}
Èö†„Çå„Åü„Éã„Éº„Ç∫: ${persona.hiddenNeeds && persona.hiddenNeeds.length > 0 ? persona.hiddenNeeds.join('„ÄÅ') : 'Áâπ„Å´„Å™„Åó'}
ÁèæÂú®„ÅÆÊ∞óÂàÜ: ${moodDescription[mood]}
Ë©±È°å: ${persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'Êó•Â∏∏„ÅÆÂõ∞„Çä„Åî„Å®'}

ÈáçË¶Å„Å™ÊåáÁ§∫:
- ÊÇ©„Åø„ÅØÊä±„Åà„Å¶„ÅÑ„Çã„Åå„ÄÅÂÆåÂÖ®„Å´„Éç„Ç¨„ÉÜ„Ç£„Éñ„Åß„ÅØ„Å™„Åè„ÄÅËß£Ê±∫„Å∏„ÅÆÊÑèÊ¨≤„ÇÇÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô
- ÊôÇ„Å´„ÅØÂâçÂêë„Åç„Å™Èù¢„ÇÑ„ÄÅÂ∞è„Åï„Å™Âñú„Å≥„ÇÇË°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- ‰∫∫ÈñìÂë≥„ÅÆ„ÅÇ„Çã„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„ÅüÂøúÁ≠î„Çí„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- ËâØ„ÅÑË≥™Âïè„Å´„ÅØÁ¥†Áõ¥„Å´Âñú„Å≥„ÄÅÂçîÂäõÁöÑ„Å™ÊÖãÂ∫¶„ÇíÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ
- Èö†„Çå„Åü„Éã„Éº„Ç∫„ÅØÁõ¥Êé•Ë®Ä„Çè„Åö„ÄÅ„Åù„Çå„Å®„Å™„ÅèÁ§∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ

‰ºöË©±Â±•Ê≠¥:
${conversationHistory}

„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆË≥™Âïè: ${question}

Ë≥™Âïè„ÇíË©ï‰æ°„Åó„Å¶ÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË©ï‰æ°Âü∫Ê∫ñ:
- Ê∑±Êéò„ÇäÂäõÔºà„Å™„Åú„Éª„Å©„ÅÜ„Åó„Å¶„ÇíËÅû„ÅÑ„Å¶„ÅÑ„Çã„ÅãÔºâ
- ÂÖ±ÊÑüÂäõÔºàÊÑüÊÉÖ„Å∏„ÅÆÁêÜËß£„ÇíÁ§∫„Åó„Å¶„ÅÑ„Çã„ÅãÔºâ
- Êé¢Á¥¢ÂäõÔºà„Ç™„Éº„Éó„É≥„Å™Ë≥™Âïè„ÅãÔºâ
- ÊñáËÑàÂäõÔºàÂâç„ÅÆ‰ºöË©±„ÇíË∏è„Åæ„Åà„Å¶„ÅÑ„Çã„ÅãÔºâ

‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂøúÁ≠î:
{
  "response": "„Éö„É´„ÇΩ„Éä„Å®„Åó„Å¶Ëá™ÁÑ∂„Åß‰∫∫ÈñìÂë≥„ÅÆ„ÅÇ„ÇãËøîÁ≠îÔºà1-3ÊñáÔºâ„ÄÇÊôÇ„Å´„ÅØÊÑüË¨ù„ÇÑÊúüÂæÖ„ÇÇË°®Áèæ",
  "score": Ë≥™Âïè„ÅÆË©ï‰æ°ÁÇπ(0-100),
  "scoreBreakdown": {
    "depth": Ê∑±Êéò„ÇäÁÇπ(0-35),
    "empathy": ÂÖ±ÊÑüÁÇπ(0-25),
    "exploration": Êé¢Á¥¢ÁÇπ(0-30),
    "context": ÊñáËÑàÁÇπ(0-10)
  },
  "newMood": "Êñ∞„Åó„ÅÑÊ∞óÂàÜ(open/normal/guard/close) - ËâØ„ÅÑË≥™Âïè„Å™„ÇâÈñãÊîæÁöÑ„Å´„ÄÅÊÇ™„ÅÑË≥™Âïè„Å™„ÇâÈñâ„Åò„Å¶„ÅÑ„Åè",
  "insight": "ÈáçË¶Å„Å™Áô∫Ë¶ã„Åå„ÅÇ„Çå„Å∞Ë®òËºâÔºà„Å™„Åë„Çå„Å∞nullÔºâ",
  "moodReason": "Ê∞óÂàÜ„ÅåÂ§â„Çè„Å£„ÅüÁêÜÁî±Ôºà1ÊñáÔºâ"
}`;
                    
                    const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin || 'http://localhost',
                            'X-Title': 'Interview Game'
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { 
                                    role: 'system', 
                                    content: '„ÅÇ„Å™„Åü„ÅØÊåáÂÆö„Åï„Çå„Åü„Éö„É´„ÇΩ„Éä„Å´„Å™„Çä„Åç„Å£„Å¶ÂøúÁ≠î„Åó„Åæ„Åô„ÄÇÈáçË¶ÅÔºö„É™„Ç¢„É´„ÅßÂÖ±ÊÑü„Åß„Åç„Çã‰∫∫Èñì„Å®„Åó„Å¶ÊåØ„ÇãËàû„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊÇ©„Åø„ÅØ„ÅÇ„Çã„ÅåÂâçÂêë„Åç„Å™Èù¢„ÇÇÊåÅ„Å°„ÄÅ„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„Å®„ÅÆÂª∫Ë®≠ÁöÑ„Å™ÂØæË©±„ÇíÊúõ„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇÈÅéÂ∫¶„Å´„Éç„Ç¨„ÉÜ„Ç£„Éñ„Å´„Å™„Çâ„Åö„ÄÅÊôÇ„Å´„ÅØÊÑüË¨ù„ÇÑÊúüÂæÖ„ÄÅÂ∞è„Åï„Å™Âñú„Å≥„ÇÇË°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂøÖ„ÅöÊúâÂäπ„Å™JSONÂΩ¢Âºè„ÅßÂøúÁ≠î„Åó„ÄÅJSON„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£Âêç„ÅØ„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÅßÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ' 
                                },
                                { role: 'user', content: promptText }
                            ],
                            temperature: 0.7,
                            max_tokens: apiModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 4000 // Sonoma: 8000, DeepSeek: 4000
                        })
                    }, 20000);
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API Response:', data);
                    
                    // ÂøúÁ≠î„ÅåÁ©∫„Åæ„Åü„ÅØÁÑ°Âäπ„Å™Â†¥Âêà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        console.error('Invalid API response structure:', data);
                        throw new Error('Invalid API response structure');
                    }
                    
                    // content„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØÁ©∫„ÅÆÂ†¥Âêà
                    if (!data.choices[0].message.content || data.choices[0].message.content.trim() === '') {
                        console.error('Empty content in API response:', data);
                        throw new Error('Empty content in API response');
                    }
                    
                    const content = data.choices[0].message.content;
                    
                    // Á©∫„ÅÆÂÜÖÂÆπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (!content || content.trim() === '') {
                        console.log('Empty content received from API, will retry...');
                        throw new Error('Empty API response');
                    }
                    
                    // JSON„Éë„Éº„ÇπË©¶Ë°å
                    let parsedResponse;
                    try {
                        // JSON„Éñ„É≠„ÉÉ„ÇØ„ÇíÊäΩÂá∫Ôºà„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„ÅÆ„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„Å´ÂØæÂøúÔºâ
                        const jsonMatch = content.match(/```json\n?([\s\S]*?)\n?```/) || 
                                         content.match(/```\n?([\s\S]*?)\n?```/) ||
                                         content.match(/\{[\s\S]*\}/);
                        
                        let jsonStr = jsonMatch ? 
                            (jsonMatch[1] || jsonMatch[0]).replace(/```json\n?|```\n?|```/g, '') : 
                            content;
                        
                        // „Çà„Åè„ÅÇ„ÇãJSON„Ç®„É©„Éº„Çí‰øÆÊ≠£
                        jsonStr = jsonStr
                            .replace(/" "/g, '""') // ‰ΩôÂàÜ„Å™„Çπ„Éö„Éº„Çπ„ÇíÂâäÈô§
                            .replace(/,\s*\}/g, '}') // Êú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                            .replace(/,\s*\]/g, ']') // ÈÖçÂàóÊú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                            .replace(/\n\s*"/g, '\n"') // ÊîπË°åÂæå„ÅÆ‰ΩôÂàÜ„Å™„Çπ„Éö„Éº„Çπ„ÇíÂâäÈô§
                            .replace(/" "([a-zA-Z]+)":/g, '"$1":'); // „Éó„É≠„Éë„ÉÜ„Ç£ÂêçÂâç„ÅÆ‰ΩôÂàÜ„Å™ÂºïÁî®Á¨¶„Çí‰øÆÊ≠£
                        
                        // ‰∏çÂÆåÂÖ®„Å™JSON„Çí‰øÆÂæ©„Åô„ÇãË©¶„Åø
                        // ÊñáÂ≠óÂåñ„Åë„ÇÑÂàáÊñ≠„Åï„Çå„ÅüJSON„ÇíÊ§úÂá∫„Åó„Å¶‰øÆÂæ©
                        if (jsonStr.includes('ins„ÄÄ') || jsonStr.includes('„Å®„Å™„Çä„Åæ„Åô') || 
                            jsonStr.includes('Êú¨ÂΩì„Å´') || /[^\x00-\x7F]{3,}$/.test(jsonStr)) {
                            console.warn('Detected corrupted JSON, attempting repair');
                            
                            // ÊúÄÂæå„ÅÆÊúâÂäπ„Å™JSONË¶ÅÁ¥†„ÇíÊé¢„Åô
                            const lastValidPositions = [
                                jsonStr.lastIndexOf('"}'),
                                jsonStr.lastIndexOf('",'),
                                jsonStr.lastIndexOf(': "'),
                                jsonStr.lastIndexOf('],'),
                                jsonStr.lastIndexOf('},')
                            ].filter(pos => pos > 0);
                            
                            if (lastValidPositions.length > 0) {
                                const cutoffPoint = Math.max(...lastValidPositions);
                                jsonStr = jsonStr.substring(0, cutoffPoint + 2);
                            }
                        }
                        
                        // ÊñáÂ≠óÂàó„ÅÆÈÄî‰∏≠„ÅßÂàá„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ‰øÆÂæ©
                        const lastQuoteIndex = jsonStr.lastIndexOf('"');
                        const secondLastQuoteIndex = jsonStr.lastIndexOf('"', lastQuoteIndex - 1);
                        if (lastQuoteIndex > secondLastQuoteIndex && 
                            !jsonStr.substring(lastQuoteIndex).includes('}')) {
                            // Êú™ÂÆå‰∫Ü„ÅÆÊñáÂ≠óÂàó„ÇíÈñâ„Åò„Çã
                            jsonStr = jsonStr.substring(0, lastQuoteIndex + 1);
                        }
                        
                        // JSON„Åå‰∏çÂÆåÂÖ®„Å´Ë¶ã„Åà„ÇãÂ†¥Âêà„ÅÆ‰øÆÂæ©
                        const openBraces = (jsonStr.match(/\{/g) || []).length;
                        const closeBraces = (jsonStr.match(/\}/g) || []).length;
                        const openBrackets = (jsonStr.match(/\[/g) || []).length;
                        const closeBrackets = (jsonStr.match(/\]/g) || []).length;
                        
                        // ÈÖçÂàó„ÇíÈñâ„Åò„Çã
                        if (openBrackets > closeBrackets) {
                            jsonStr += ']'.repeat(openBrackets - closeBrackets);
                        }
                        
                        // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÈñâ„Åò„Çã
                        if (openBraces > closeBraces) {
                            jsonStr += '}'.repeat(openBraces - closeBraces);
                        }
                        
                        // Á©∫„ÅÆJSON„ÉÅ„Çß„ÉÉ„ÇØ
                        if (!jsonStr || jsonStr.trim() === '') {
                            throw new Error('Empty JSON string');
                        }
                        
                        parsedResponse = JSON.parse(jsonStr);
                        
                        // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆÊ§úË®º„Å®„Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
                        if (!parsedResponse.response) {
                            throw new Error('No response text found');
                        }
                        
                        // „Çπ„Ç≥„Ç¢„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ‰∏çÊ≠£„Å™ÂÄ§„ÅÆÂ†¥Âêà„ÅØË®àÁÆó„Åô„Çã
                        if (typeof parsedResponse.score !== 'number' || parsedResponse.score < 0 || parsedResponse.score > 100) {
                            const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                            parsedResponse.score = score;
                            parsedResponse.breakdown = breakdown;
                        }
                        
                        // breakdown„Åå‰∏çÂÆåÂÖ®„Å™Â†¥Âêà„ÅØÂÜçË®àÁÆó
                        if (!parsedResponse.breakdown || typeof parsedResponse.breakdown !== 'object') {
                            const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                            parsedResponse.breakdown = breakdown;
                        }
                        
                        // newMood„ÅÆÊ§úË®º„Å®‰øÆÊ≠£
                        if (!parsedResponse.newMood || !['open', 'normal', 'guard', 'close'].includes(parsedResponse.newMood)) {
                            // „Çπ„Ç≥„Ç¢„Å´Âü∫„Å•„ÅÑ„Å¶Ê∞óÂàÜ„ÇíÊõ¥Êñ∞
                            let newMood = mood;
                            const score = parsedResponse.score || 50;
                            
                            // „Çà„ÇäÁ©çÊ•µÁöÑ„Å™Ê∞óÂàÜÂ§âÂåñ
                            if (score >= 80) {
                                // Á¥†Êô¥„Çâ„Åó„ÅÑË≥™Âïè - Â§ßÂπÖ„Å´ÈñãÊîæÁöÑ„Å´
                                if (mood === 'close') newMood = 'normal';
                                else if (mood === 'guard') newMood = 'open';
                                else newMood = 'open';
                            } else if (score >= 60) {
                                // ËâØ„ÅÑË≥™Âïè - Â∞ë„ÅóÈñãÊîæÁöÑ„Å´
                                if (mood === 'close') newMood = 'guard';
                                else if (mood === 'guard') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'open';
                            } else if (score <= 30) {
                                // ÊÇ™„ÅÑË≥™Âïè - Èñâ„Åò„Å¶„ÅÑ„Åè
                                if (mood === 'open') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'guard';
                                else newMood = 'close';
                            } else if (score <= 40) {
                                // „ÇÑ„ÇÑÊÇ™„ÅÑË≥™Âïè
                                if (mood === 'open') newMood = 'normal';
                                else if (mood === 'normal') newMood = 'guard';
                            }
                            parsedResponse.newMood = newMood;
                        }
                        
                        // Ê∞óÂàÜÂ§âÂåñ„ÅÆÁêÜÁî±„ÇíËøΩÂä†
                        if (parsedResponse.newMood !== mood && !parsedResponse.moodReason) {
                            const reasons = {
                                'open': ['Ë≥™Âïè„ÅåÁöÑÁ¢∫„ÅßË©±„Åó„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åó„Åü', 'ÁêÜËß£„Åó„Å¶„ÇÇ„Çâ„Åà„Å¶„ÅÑ„Çã„Å®ÊÑü„Åò„Åæ„Åô'],
                                'normal': ['ÊôÆÈÄö„Å´Ë©±„Åõ„Åù„ÅÜ„Åß„Åô', 'Â∞ë„ÅóÊßòÂ≠ê„ÇíË¶ã„Å¶„ÅÑ„Åæ„Åô'],
                                'guard': ['„Å°„Çá„Å£„Å®Á≠î„Åà„Å´„Åè„ÅÑË≥™Âïè„Åß„Åó„Åü', 'Â∞ë„ÅóË≠¶Êàí„Åó„Å¶„ÅÑ„Åæ„Åô'],
                                'close': ['„Åì„ÅÆË©±È°å„ÅØÈÅø„Åë„Åü„ÅÑ„Åß„Åô', 'Ë≥™Âïè„ÅÆÊÑèÂõ≥„ÅåÂàÜ„Åã„Çä„Åæ„Åõ„Çì']
                            };
                            parsedResponse.moodReason = reasons[parsedResponse.newMood]?.[Math.floor(Math.random() * 2)] || '';
                        }
                        
                        // insight„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
                        if (parsedResponse.score > 80 && !parsedResponse.insight) {
                            const insights = [
                                'Êú¨Ë≥™ÁöÑ„Å™Ë™≤È°å„ÇíÁô∫Ë¶ã',
                                'Èö†„Çå„Åü„Éã„Éº„Ç∫„ÇíÁâπÂÆö',
                                'ÊÑüÊÉÖ„ÅÆÊ†πÊ∫ê„ÇíÁô∫Ë¶ã',
                                'ÁêÜÊÉ≥„Å®ÁèæÂÆü„ÅÆ„ÇÆ„É£„ÉÉ„Éó„ÇíÁô∫Ë¶ã'
                            ];
                            parsedResponse.insight = insights[Math.floor(Math.random() * insights.length)];
                        }
                        
                    } catch (e) {
                        console.error('JSON Parse Error:', e, 'Content:', content);
                        
                        // JSON„Éë„Éº„Çπ„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅÂÜÖÂÆπ„Åã„ÇâÂøÖË¶Å„Å™ÊÉÖÂ†±„ÇíÊäΩÂá∫„Åô„ÇãË©¶„Åø
                        let extractedResponse = null;
                        
                        // response„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
                        const responseMatch = content.match(/"response"\s*:\s*"([^"]+)"/);
                        if (responseMatch) {
                            extractedResponse = responseMatch[1];
                        }
                        
                        // „Åù„Çå„Åß„ÇÇË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆÊó•Êú¨Ë™ûÊñá„Çí‰ΩøÁî®
                        if (!extractedResponse) {
                            const japaneseMatch = content.match(/[„ÅÅ-„Çì„Ç°-„É∂„Éº‰∏Ä-Èæ†].+[„ÄÇÔºÅÔºü]/);
                            if (japaneseMatch) {
                                extractedResponse = japaneseMatch[0];
                            }
                        }
                        
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î„ÅÆÁîüÊàê
                        const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                        parsedResponse = {
                            response: extractedResponse || '„Åù„ÅÜ„Åß„Åô„Å≠„ÄÅ„Åù„Çå„ÅØËààÂë≥Ê∑±„ÅÑË≥™Âïè„Åß„Åô„Å≠„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóË©≥„Åó„Åè„ÅäËÅû„Åã„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ',
                            score: score,
                            breakdown: breakdown,
                            newMood: mood,
                            insight: null,
                            moodReason: 'APIÂøúÁ≠î„ÅÆËß£Êûê„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åó„Åü'
                        };
                        
                        // „É¶„Éº„Ç∂„Éº„Å´ËªΩ„ÅÑ„Ç®„É©„ÉºÈÄöÁü•
                        console.warn('JSON parsing failed, using extracted response:', extractedResponse);
                    }
                    
                    console.log('Final parsed response:', parsedResponse);
                        setIsTyping(false);
                        return parsedResponse;
                        
                    } catch (error) {
                        lastError = error;
                        retryCount++;
                        console.error(`API Error (attempt ${retryCount}):`, error);
                        
                        if (retryCount >= maxRetries) {
                            console.error('Max retries reached, using fallback');
                            break;
                        }
                    }
                }
                
                // „Åô„Åπ„Å¶„ÅÆ„É™„Éà„É©„Ç§„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà
                console.error('All retries failed, using fallback response');
                showToast('APIÂøúÁ≠î„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂøúÁ≠î„Çí‰ΩøÁî®„Åó„Åæ„Åô', 'warning');
                
                const fallbackResponses = [
                    '„Åù„ÅÜ„Åß„Åô„Å≠„ÄÅ„Åù„Çå„Å´„Å§„ÅÑ„Å¶„ÇÇ„ÅÜÂ∞ë„ÅóË©≥„Åó„ÅèÊïô„Åà„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü',
                    '„Å™„Çã„Åª„Å©„ÄÅËààÂë≥Ê∑±„ÅÑ„ÅäË©±„Åß„Åô„Å≠„ÄÇÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™ÊÑü„Åò„Åß„Åó„Çá„ÅÜ„ÅãÔºü',
                    '„Åù„ÅÆÁÇπ„ÅØÁ¢∫„Åã„Å´ÈáçË¶Å„Åß„Åô„Å≠„ÄÇÊôÆÊÆµ„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å´ÂØæÂá¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü'
                ];
                
                const { score, breakdown } = calculateScore(question, messages.length > 0 ? messages[messages.length - 1].content : '');
                
                setIsTyping(false);
                return {
                    response: fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)],
                    score: Math.max(20, score),
                    breakdown,
                    newMood: mood,
                    insight: null
                };
            }, [apiKey, apiModel, mood, persona, calculateScore, messages, gameLogic]);
            
            // Ë≥™ÂïèÈÄÅ‰ø°Âá¶ÁêÜ
            const handleSubmitQuestion = useCallback(async () => {
                if (!currentQuestion.trim() || questionCount >= maxQuestions) return;
                
                // Ë≥™ÂïèÂÜÖÂÆπ„Çí‰øùÂ≠ò„Åó„Å¶„Åã„Çâ„ÄÅ„Åô„Åê„Å´ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
                const questionText = currentQuestion;
                setCurrentQuestion('');
                
                // Clear input immediately and manage focus
                if (inputRef.current) {
                    inputRef.current.value = '';
                    // Only blur on mobile to hide keyboard after sending
                    if (isMobile) {
                        inputRef.current.blur();
                    }
                }
                
                // Scroll to bottom after sending message
                // „É¶„Éº„Ç∂„Éº„Åå„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„ÅüÂæå„ÅØÂøÖ„Åö„Çπ„ÇØ„É≠„Éº„É´
                scrollToLatest();
                
                const userMessage = {
                    type: 'user',
                    content: questionText,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                const newQuestionCount = questionCount + 1;
                setQuestionCount(newQuestionCount);
                
                // „É¶„Éº„Ç∂„Éº„Åå„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„ÅüÊôÇ„ÅØÂøÖ„ÅöÊúÄÊñ∞„ÇíË°®Á§∫
                scrollToLatest();
                
                const aiResponse = await generateAIResponse(questionText);
                
                // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞
                const newScore = currentScore + aiResponse.score;
                setCurrentScore(newScore);
                setScoreHistory(prev => [...prev, aiResponse.score]);
                setTalkMeter(prev => Math.min(100, prev + (aiResponse.score / 10)));
                setMood(aiResponse.newMood);
                
                // È´òÂæóÁÇπÊôÇ„ÅÆÊºîÂá∫Ôºà„Çà„ÇäÈ†ªÁπÅ„Å´Áô∫ÁîüÔºâ
                if (aiResponse.score >= 60) { // ÈñæÂÄ§„Çí‰∏ã„Åí„Çã
                    const newComboCount = comboCount + 1;
                    setComboCount(newComboCount);
                    if (newComboCount >= 2) { // 2ÂõûÁõÆ„Åã„ÇâË°®Á§∫
                        showToast(`üî• ${newComboCount}ÈÄ£Á∂ö„Ç≥„É≥„ÉúÔºÅ +${newComboCount * 20}„Éú„Éº„Éä„Çπ`, 'success');
                        setCurrentScore(prev => prev + newComboCount * 20);
                    }
                    triggerParticles();
                } else {
                    if (comboCount > 2) {
                        showToast('üíî „Ç≥„É≥„Éú„ÅåÈÄîÂàá„Çå„Åæ„Åó„Åü', 'warning');
                    }
                    setComboCount(0);
                }
                
                // „Çπ„Éö„Ç∑„É£„É´„Éú„Éº„Éä„Çπ
                if (aiResponse.score >= 90) {
                    showToast('‚≠ê „Éë„Éº„Éï„Çß„ÇØ„ÉàË≥™ÂïèÔºÅ +50„Éú„Éº„Éä„Çπ', 'success');
                    setCurrentScore(prev => prev + 50);
                    // ÁâπÂà•„Å™„Ç®„Éï„Çß„ÇØ„Éà
                    document.body.style.animation = 'pulse 0.5s';
                    setTimeout(() => document.body.style.animation = '', 500);
                }
                
                // „Éô„Çπ„ÉàË≥™Âïè„ÅÆË®òÈå≤
                if (aiResponse.score >= 80) {
                    setBestQuestions(prev => [...prev, { question: currentQuestion, score: aiResponse.score }]
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 3));
                }
                
                // „Ç§„É≥„Çµ„Ç§„ÉàÁô∫Ë¶ã
                if (aiResponse.insight) {
                    setInsights(prev => [...prev, aiResponse.insight]);
                    showToast('üí° „Ç§„É≥„Çµ„Ç§„ÉàÁô∫Ë¶ãÔºÅ', 'success');
                    checkAchievements('insight');
                }
                
                // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„ÉÅ„Çß„ÉÉ„ÇØ
                checkAchievements('score', aiResponse.score);
                if (questionCount === 0) {
                    checkAchievements('firstQuestion');
                }
                if (comboCount >= 3) {
                    checkAchievements('combo3');
                }
                if (comboCount >= 5) {
                    checkAchievements('combo5');
                }
                
                const aiMessage = {
                    type: 'ai',
                    content: aiResponse.response,
                    score: aiResponse.score,
                    breakdown: aiResponse.breakdown,
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, aiMessage]);
                
                // AI„ÅåÂøúÁ≠î„Åó„ÅüÊôÇ„ÇÇÊúÄÊñ∞„ÇíË°®Á§∫
                scrollToLatest();
                
                // „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë°®Á§∫Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
                console.log('Question Score Details:', {
                    question: questionText,
                    score: aiResponse.score,
                    breakdown: aiResponse.breakdown,
                    mood: mood,
                    newMood: aiResponse.newMood
                });
                
                // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÔºàË≥™ÂïèÊï∞„ÅÆ„Åø„ÅßÂà§ÂÆöÔºâ
                console.log(`Question ${newQuestionCount} of ${maxQuestions} completed`);
                if (newQuestionCount >= maxQuestions) {
                    console.log('Game ending - starting analysis...');
                    // „Ç≥„É≥„Éú„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
                    setComboCount(0);
                    // „Ç≤„Éº„É†ÂÆå‰∫ÜÊôÇ„ÅÆ„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà
                    checkAchievements('gameComplete');
                    const newTotal = totalGamesPlayed + 1;
                    setTotalGamesPlayed(newTotal);
                    localStorage.setItem('totalGamesPlayed', newTotal.toString());
                    
                    // Èö†„Åó„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„ÉÅ„Çß„ÉÉ„ÇØ
                    if (insights.length >= 5) {
                        checkAchievements('hiddenGenius');
                    }
                    
                    // „Çπ„Éî„Éº„Éâ„É©„É≥„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç≤„Éº„É†ÈñãÂßãÊôÇÂàª„ÇíË®òÈå≤„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„ÇãÔºâ
                    const gameTime = Date.now() - (window.gameStartTime || Date.now());
                    if (gameTime < 180000) { // 3ÂàÜ‰ª•ÂÜÖ
                        checkAchievements('speedDemon');
                    }
                    
                    // „Éè„Ç§„Çπ„Ç≥„Ç¢Êõ¥Êñ∞
                    const finalScore = currentScore + aiResponse.score;
                    const newHighScores = { ...highScores };
                    if (!newHighScores[difficulty] || finalScore > newHighScores[difficulty]) {
                        newHighScores[difficulty] = finalScore;
                        setHighScores(newHighScores);
                        localStorage.setItem('highScores', JSON.stringify(newHighScores));
                        showToast('üèÜ Êñ∞Ë®òÈå≤ÈÅîÊàêÔºÅ', 'success');
                    }
                    
                    // Á∑è„Çπ„Ç≥„Ç¢Êõ¥Êñ∞
                    const newTotalScore = totalScore + finalScore;
                    setTotalScore(newTotalScore);
                    localStorage.setItem('totalScore', newTotalScore.toString());
                    
                    // „Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„ÉâÁâπÂà•„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà
                    if (difficulty === 'expert' && finalScore >= 800) {
                        checkAchievements('expertMaster');
                    }
                    
                    // „Éë„Éº„Éï„Çß„ÇØ„Éà„Ç≤„Éº„É†„ÉÅ„Çß„ÉÉ„ÇØ
                    const allHighScores = scoreHistory.every(s => s >= 70);
                    if (allHighScores && currentMission === 'perfect') {
                        checkAchievements('perfectGame');
                    }
                    
                    setTimeout(async () => {
                        console.log('Starting AI analysis...');
                        // AI„Åß‰ºöË©±„ÇíÂàÜÊûê
                        try {
                            await generateAIAnalysis();
                            console.log('AI analysis completed, switching to result screen');
                        } catch (error) {
                            console.error('AI analysis failed:', error);
                        }
                        setGameState('result');
                    }, 2000);
                }
            }, [currentQuestion, questionCount, maxQuestions, generateAIResponse, comboCount, currentScore, generateAIAnalysis, checkAchievements, totalGamesPlayed, highScores, difficulty, totalScore, currentMission, scoreHistory, showToast, insights]);
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà
            const triggerParticles = useCallback(() => {
                setShowParticles(true);
                setTimeout(() => setShowParticles(false), 3000);
            }, []);
            
            // „Éà„Éº„Çπ„ÉàÈÄöÁü•
            const showToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            }, []);
            
            // „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„Ç∑„Çπ„ÉÜ„É†
            const checkAchievements = useCallback((type, value = null) => {
                const newAchievements = [];
                
                switch(type) {
                    case 'firstQuestion':
                        if (!localStorage.getItem('achievement_firstQuestion')) {
                            newAchievements.push({
                                id: 'firstQuestion',
                                name: 'üéØ Âàù„ÇÅ„Å¶„ÅÆË≥™Âïè',
                                description: 'ÊúÄÂàù„ÅÆË≥™Âïè„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü'
                            });
                        }
                        break;
                    case 'score':
                        if (value >= 95 && !localStorage.getItem('achievement_perfect')) {
                            newAchievements.push({
                                id: 'perfect',
                                name: '‚≠ê „Éë„Éº„Éï„Çß„ÇØ„ÉàË≥™Âïè',
                                description: '95ÁÇπ‰ª•‰∏ä„ÅÆË≥™Âïè„ÇíÈÅîÊàêÔºàÈ´òÈõ£ÊòìÂ∫¶Ôºâ'
                            });
                        }
                        break;
                    case 'combo3':
                        if (!localStorage.getItem('achievement_combo3')) {
                            newAchievements.push({
                                id: 'combo3',
                                name: 'üî• 3ÈÄ£Á∂ö„Ç≥„É≥„Éú',
                                description: '3ÂõûÈÄ£Á∂ö„ÅßËâØ„ÅÑË≥™Âïè„ÇíÈÅîÊàê'
                            });
                        }
                        break;
                    case 'combo5':
                        if (!localStorage.getItem('achievement_combo5')) {
                            newAchievements.push({
                                id: 'combo5',
                                name: 'üí• 5ÈÄ£Á∂ö„Ç≥„É≥„Éú„Éû„Çπ„Çø„Éº',
                                description: '5ÂõûÈÄ£Á∂ö„ÅßËâØ„ÅÑË≥™Âïè„ÇíÈÅîÊàê'
                            });
                        }
                        break;
                    case 'insight':
                        if (!localStorage.getItem('achievement_insight')) {
                            newAchievements.push({
                                id: 'insight',
                                name: 'üí° „Ç§„É≥„Çµ„Ç§„ÉàÁô∫Ë¶ãËÄÖ',
                                description: 'ÈáçË¶Å„Å™„Ç§„É≥„Çµ„Ç§„Éà„ÇíÁô∫Ë¶ã'
                            });
                        }
                        break;
                    case 'expertMaster':
                        if (!localStorage.getItem('achievement_expertMaster')) {
                            newAchievements.push({
                                id: 'expertMaster',
                                name: 'üëë „Ç®„Ç≠„Çπ„Éë„Éº„Éà„Éû„Çπ„Çø„Éº',
                                description: '„Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„Éâ„Åß900ÁÇπ‰ª•‰∏äÈÅîÊàê'
                            });
                        }
                        break;
                    case 'perfectGame':
                        if (!localStorage.getItem('achievement_perfectGame')) {
                            newAchievements.push({
                                id: 'perfectGame',
                                name: 'üíé „Éë„Éº„Éï„Çß„ÇØ„Éà„Ç≤„Éº„É†',
                                description: 'ÂÖ®Ë≥™Âïè80ÁÇπ‰ª•‰∏ä„Åß„ÇØ„É™„Ç¢'
                            });
                        }
                        break;
                    case 'hiddenGenius':
                        if (!localStorage.getItem('achievement_hiddenGenius')) {
                            newAchievements.push({
                                id: 'hiddenGenius',
                                name: 'üß† Èö†„Çå„ÅüÂ§©Êâç',
                                description: '1Âõû„ÅÆ„Ç≤„Éº„É†„Åß5„Å§‰ª•‰∏ä„ÅÆ„Ç§„É≥„Çµ„Ç§„ÉàÁô∫Ë¶ã'
                            });
                        }
                        break;
                    case 'speedDemon':
                        if (!localStorage.getItem('achievement_speedDemon')) {
                            newAchievements.push({
                                id: 'speedDemon',
                                name: '‚ö° „Çπ„Éî„Éº„Éâ„Éá„Éº„É¢„É≥',
                                description: '3ÂàÜ‰ª•ÂÜÖ„Å´„Ç≤„Éº„É†„ÇØ„É™„Ç¢'
                            });
                        }
                        break;
                    case 'legendaryInterviewer':
                        if (!localStorage.getItem('achievement_legendaryInterviewer') && totalGamesPlayed >= 50) {
                            newAchievements.push({
                                id: 'legendaryInterviewer',
                                name: 'üåü ‰ºùË™¨„ÅÆ„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº',
                                description: '50Âõû„Éó„É¨„Ç§ÔºÜÂπ≥Âùá„Çπ„Ç≥„Ç¢80ÁÇπ‰ª•‰∏ä'
                            });
                        }
                        break;
                    case 'secretEnding':
                        // „Ç§„Éº„Çπ„Çø„Éº„Ç®„ÉÉ„Ç∞: ÁâπÂÆö„ÅÆË≥™Âïè„Éë„Çø„Éº„É≥„ÅßËß£Èô§
                        if (!localStorage.getItem('achievement_secretEnding')) {
                            newAchievements.push({
                                id: 'secretEnding',
                                name: 'üîÆ ÁßòÂØÜ„ÅÆÁµÇ„Çè„Çä',
                                description: '??? „ÇíÁô∫Ë¶ã„Åó„Åü'
                            });
                        }
                        break;
                    case 'gameComplete':
                        const gamesPlayed = totalGamesPlayed + 1;
                        if (gamesPlayed === 1) {
                            newAchievements.push({
                                id: 'firstGame',
                                name: 'üéÆ „Ç≤„Éº„É†„Éá„Éì„É•„Éº',
                                description: 'Âàù„ÇÅ„Å¶„Ç≤„Éº„É†„ÇíÂÆå‰∫Ü'
                            });
                        }
                        if (gamesPlayed === 10) {
                            newAchievements.push({
                                id: 'veteran',
                                name: 'üèÖ „Éô„ÉÜ„É©„É≥„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº',
                                description: '10Âõû„Ç≤„Éº„É†„Çí„Éó„É¨„Ç§'
                            });
                        }
                        break;
                }
                
                // Êñ∞„Åó„ÅÑ„Ç¢„ÉÅ„Éº„Éñ„É°„É≥„Éà„ÇíË®òÈå≤
                newAchievements.forEach(achievement => {
                    localStorage.setItem(`achievement_${achievement.id}`, 'true');
                    setAchievements(prev => [...prev, achievement]);
                    showToast(`üèÜ „Ç¢„ÉÅ„Éº„Éñ„É°„É≥„ÉàËß£Èô§: ${achievement.name}`, 'success');
                });
            }, [showToast, totalGamesPlayed]);
            
            // „Ç≤„Éº„É†ÈñãÂßãÔºà„Éö„É´„ÇΩ„ÉäÁ¢∫Ë™çÁîªÈù¢„Å∏Ôºâ
            const startGame = useCallback(async () => {
                const finalPainPoint = customPainPoint || selectedPainPoint;
                if (!finalPainPoint) {
                    showToast('Âõ∞„Çä„Åî„Å®„ÇíÈÅ∏Êäû„Åô„Çã„Åã„ÄÅ„Ç´„Çπ„Çø„É†ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                    return;
                }
                
                if (!apiTested) {
                    showToast('ÂÖà„Å´API„Çí„ÉÜ„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
                    return;
                }
                
                const aiPersona = await generatePersonaWithAI(finalPainPoint);
                const personaCandidate = aiPersona || generatePersona(finalPainPoint);
                setPersona(personaCandidate);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_PERSONA = personaCandidate;
                }
                setShowPersonaInfo(false);
                setGameState('persona');
            }, [selectedPainPoint, customPainPoint, generatePersona, generatePersonaWithAI, showToast, apiTested]);
            
            // „Ç§„É≥„Çø„Éì„É•„ÉºÈñãÂßãÔºà„Éö„É´„ÇΩ„ÉäÁ¢∫Ë™çÂæåÔºâ
            const startInterview = useCallback(() => {
                if (!persona) return;
                
                const mainPainPoint = persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'Âõ∞„Çä„Åî„Å®';

                setGameState('playing');
                setCurrentScore(0);
                setQuestionCount(0);
                setTalkMeter(0);
                setMood('normal');
                
                // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË®≠ÂÆö
                setMessages([{
                    type: 'system',
                    content: `„Åì„Çì„Å´„Å°„ÅØÔºÅ${persona.name}„Åï„Çì„ÅÆ„Äå${persona.painPoints?.[0] || 'Âõ∞„Çä„Åî„Å®'}„Äç„Å´„Å§„ÅÑ„Å¶Ë©±„ÇíËÅû„Åã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                }]);
                
                window.gameStartTime = Date.now();
                
                // „Éö„Ç§„É≥„Éù„Ç§„É≥„Éà„ÇíËá™ÁÑ∂„Å™Ë°®Áèæ„Å´Â§âÊèõ
                const naturalPainPoint = (() => {
                    // ‰∏çË¶Å„Å™Ë™ûÂ∞æ„ÇíÈô§Âéª
                    let cleaned = mainPainPoint
                        .replace(/„ÅßÂõ∞„Å£„Å¶„ÅÑ„Çã|„Å´Âõ∞„Å£„Å¶„ÅÑ„Çã|„Å¶„Åó„Åæ„ÅÜ|„Åó„Å¶„Åó„Åæ„ÅÜ|Âõ∞„Å£„Å¶„ÅÑ„Çã/g, '')
                        .replace(/„ÄÅ/g, '')
                        .trim();
                    
                    // Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØË¶ÅÁ¥ÑÁöÑ„Å´
                    if (cleaned.length > 40) {
                        // ÊúÄÂàù„ÅÆ‰∏ªË¶Å„Å™ÂïèÈ°åÈÉ®ÂàÜ„ÇíÊäΩÂá∫
                        const mainIssue = cleaned.match(/^([^„ÄÅ„ÄÇ]+)/);
                        if (mainIssue) {
                            return mainIssue[1] + '„Åì„Å®';
                        }
                        // „Åù„Çå„Åß„ÇÇÈï∑„ÅÑÂ†¥Âêà„ÅØ30ÊñáÂ≠ó„Åß„Ç´„ÉÉ„Éà
                        return cleaned.substring(0, 30) + '...„Åì„Å®';
                    }
                    
                    // „Äå„Åì„Å®„Äç„ÅßÁµÇ„Çè„Å£„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
                    if (!cleaned.endsWith('„Åì„Å®')) {
                        return cleaned + '„Åì„Å®';
                    }
                    
                    return cleaned;
                })();
                
                const initialMessage = {
                    type: 'ai',
                    content: `„Åì„Çì„Å´„Å°„ÅØÔºÅ${persona.name}„Åß„Åô„ÄÇ‰ªäÊó•„ÅØ„ÅäÊôÇÈñì„Çí„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇÂÆü„ÅØÊúÄËøë„ÄÅ${naturalPainPoint}„ÅßÂ∞ë„ÅóÊÇ©„Çì„Åß„ÅÑ„Å¶...„ÄÇ‰Ωï„Åã„Ç¢„Éâ„Éê„Ç§„Çπ„Çí„ÅÑ„Åü„Å†„Åë„Åü„ÇâÂ¨â„Åó„ÅÑ„Åß„Åô„ÄÇ„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„Åó„Åæ„ÅôÔºÅ`,
                    timestamp: new Date()
                };
                console.log('Setting initial message:', initialMessage);
                setMessages([initialMessage]);
                setScoreHistory([]);
                setInsights([]);
                setBestQuestions([]);
                setComboCount(0);
                setShowPersonaInfo(false);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_STATE = 'playing';
                }
            }, [persona]);

            useEffect(() => {
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_FORCE_RESULT = async () => {
                        await generateAIAnalysis();
                        setGameState('result');
                    };
                    window.__PLAYWRIGHT_STATE = gameState;
                }
            }, [generateAIAnalysis, gameState]);

            // „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà
            const resetGame = useCallback(() => {
                setGameState('menu');
                setCurrentScore(0);
                setQuestionCount(0);
                setTalkMeter(0);
                setMood('normal');
                setMessages([]); // Reset messages for new game
                setCurrentQuestion('');
                setScoreHistory([]);
                setInsights([]);
                setBestQuestions([]);
                setComboCount(0);
                setPersona(null);
                setSelectedPainPoint('');
                setCustomPainPoint('');
                setShowPersonaInfo(false);
                if (typeof window !== 'undefined') {
                    window.__PLAYWRIGHT_STATE = 'menu';
                }
            }, []);
            
            // „Çπ„Éû„Éº„Éà„Å™Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´Ôºà„É¶„Éº„Ç∂„Éº„ÅåÊúÄ‰∏ãÈÉ®„Å´„ÅÑ„ÇãÊôÇ„ÅÆ„ÅøÔºâ
            const [isUserScrolling, setIsUserScrolling] = React.useState(false);
            const [shouldAutoScroll, setShouldAutoScroll] = React.useState(true);
            
            // „Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÁõ£Ë¶ñ
            const checkIfAtBottom = useCallback(() => {
                if (!chatAreaRef.current) return true;
                const { scrollTop, scrollHeight, clientHeight } = chatAreaRef.current;
                // ÊúÄ‰∏ãÈÉ®„Åã„Çâ100px‰ª•ÂÜÖ„Å™„Çâ„ÄåÊúÄ‰∏ãÈÉ®„Å´„ÅÑ„Çã„Äç„Å®Âà§ÂÆö
                return scrollHeight - scrollTop - clientHeight < 100;
            }, []);
            
            // „É¶„Éº„Ç∂„Éº„Åå„Çπ„ÇØ„É≠„Éº„É´„Åó„ÅüÊôÇ
            const handleScroll = useCallback(() => {
                if (chatAreaRef.current) {
                    const isAtBottom = checkIfAtBottom();
                    setShouldAutoScroll(isAtBottom);
                }
            }, [checkIfAtBottom]);
            
            // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåËøΩÂä†„Åï„Çå„ÅüÊôÇ„ÅÆËá™Âãï„Çπ„ÇØ„É≠„Éº„É´
            useEffect(() => {
                // ÊúÄ‰∏ãÈÉ®„Å´„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÂàùÂõûË°®Á§∫ÊôÇ„ÅÆ„ÅøËá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                if (shouldAutoScroll && messagesEndRef.current) {
                    setTimeout(() => {
                        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 100);
                }
            }, [messages, shouldAutoScroll]);
            
            // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÊôÇ„ÅØÂøÖ„Åö„Çπ„ÇØ„É≠„Éº„É´
            const scrollToLatest = useCallback(() => {
                setShouldAutoScroll(true);
                setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);
            }, []);
            
            // Ê∞óÂàÜ„Å´Âøú„Åò„ÅüËÉåÊôØËâ≤Â§âÊõ¥
            const getMoodColor = useCallback(() => {
                switch(mood) {
                    case 'open': return 'from-green-400 to-blue-500';
                    case 'normal': return 'from-blue-400 to-purple-500';
                    case 'guard': return 'from-yellow-400 to-orange-500';
                    case 'close': return 'from-red-400 to-pink-500';
                    default: return 'from-blue-400 to-purple-500';
                }
            }, [mood]);
            
            // ÁµêÊûúÁîªÈù¢„ÅÆ„É©„É≥„ÇØË®àÁÆóÔºàÁ∑èÂêà„Çπ„Ç≥„Ç¢„Å®Âπ≥Âùá„Çπ„Ç≥„Ç¢„ÅßÂà§ÂÆöÔºâ
            const calculateRank = useCallback(() => {
                const avgScore = scoreHistory.length > 0 ? 
                    scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length : 0;
                
                // Á∑èÂêà„Çπ„Ç≥„Ç¢„Å®Âπ≥Âùá„Çπ„Ç≥„Ç¢„ÅÆ‰∏°Êñπ„ÇíËÄÉÊÖÆ
                if (currentScore >= 1500 && avgScore >= 95) return 'SSS';
                if (currentScore >= 1200 && avgScore >= 90) return 'SS';
                if (currentScore >= 1000 && avgScore >= 85) return 'S';
                if (currentScore >= 800 && avgScore >= 80) return 'A';
                if (currentScore >= 600 && avgScore >= 70) return 'B';
                if (currentScore >= 400 && avgScore >= 60) return 'C';
                if (currentScore >= 200 && avgScore >= 50) return 'D';
                return 'E';
            }, [currentScore, scoreHistory]);
            
            // Ë©≥Á¥∞„Å™ÂàÜÊûê„Å®„Ç¢„Éâ„Éê„Ç§„ÇπÁîüÊàê
            const generateDetailedAnalysis = useCallback(() => {
                const avgScore = scoreHistory.length > 0 ? 
                    scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length : 0;
                
                // Ë≥™Âïè„Éë„Çø„Éº„É≥ÂàÜÊûê
                const questionPatterns = messages.filter(m => m.type === 'user').map(m => {
                    const q = m.content;
                    return {
                        hasWhy: q.includes('„Å™„Åú') || q.includes('„Å©„ÅÜ„Åó„Å¶'),
                        hasHow: q.includes('„Å©„ÅÆ„Çà„ÅÜ„Å´') || q.includes('„Å©„ÅÜ„ÇÑ„Å£„Å¶'),
                        hasFeel: q.includes('ÊÑü„Åò') || q.includes('ÊÄù„ÅÑ'),
                        isOpen: !q.includes('„Åß„Åô„ÅãÔºü') && !q.includes('„Åæ„Åô„ÅãÔºü'),
                        length: q.length
                    };
                });
                
                const whyQuestions = questionPatterns.filter(p => p.hasWhy).length;
                const openQuestions = questionPatterns.filter(p => p.isOpen).length;
                const avgLength = questionPatterns.reduce((sum, p) => sum + p.length, 0) / questionPatterns.length;
                
                // Âº∑„Åø„ÅÆÂàÜÊûê
                const strengths = [];
                if (whyQuestions >= 5) {
                    strengths.push({
                        title: 'Ê∑±Êéò„ÇäÂäõ„ÅåÂÑ™ÁßÄ',
                        detail: `${whyQuestions}Âõû„ÅÆ„Äå„Å™„Åú„ÄçË≥™Âïè„ÅßÊú¨Ë≥™„Å´Ëø´„ÇãÂßøÂã¢„ÅåÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åß„Åô„ÄÇÁõ∏Êâã„ÅÆË°®Èù¢ÁöÑ„Å™ÂõûÁ≠î„Å´Ê∫ÄË∂≥„Åõ„Åö„ÄÅÊ†πÊú¨ÂéüÂõ†„ÇíÊé¢Ê±Ç„Åô„ÇãÁøíÊÖ£„ÅåË∫´„Å´„Å§„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
                    });
                }
                if (openQuestions >= 7) {
                    strengths.push({
                        title: '„Ç™„Éº„Éó„É≥„ÇØ„Ç®„Çπ„ÉÅ„Éß„É≥„ÅÆÊ¥ªÁî®',
                        detail: `${openQuestions}Âõû„ÅÆ„Ç™„Éº„Éó„É≥Ë≥™Âïè„Çí‰ΩøÁî®„ÄÇÁõ∏Êâã„Å´Ëá™Áî±„Å´Ë©±„Åó„Å¶„ÇÇ„Çâ„ÅÜÁí∞Â¢É„Çí‰Ωú„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä‰∫àÊÉ≥Â§ñ„ÅÆÁô∫Ë¶ã„ÅåÁîü„Åæ„Çå„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ`
                    });
                }
                if (avgScore >= 70) {
                    strengths.push({
                        title: 'Ë≥™Âïè„ÅÆË≥™„ÅåÈ´ò„ÅÑ',
                        detail: `Âπ≥Âùá${Math.round(avgScore)}ÁÇπ„Å®„ÅÑ„ÅÜÈ´òÂæóÁÇπ„ÄÇÁõ∏Êâã„ÅÆÂøÉÁêÜÁä∂ÊÖã„ÇíË™≠„ÅøÂèñ„Çä„ÄÅÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÈÅ©Âàá„Å™Ë≥™Âïè„Åå„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇ`
                    });
                }
                if (comboCount >= 3) {
                    strengths.push({
                        title: 'ÊµÅ„Çå„Çí‰Ωú„ÇãÂäõ',
                        detail: 'ÈÄ£Á∂ö„Åó„Å¶ËâØ„ÅÑË≥™Âïè„Åå„Åß„Åç„Å¶„Åä„Çä„ÄÅ‰ºöË©±„ÅÆÊµÅ„Çå„Çí‰∏äÊâã„Å´„Ç≥„É≥„Éà„É≠„Éº„É´„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇÁõ∏Êâã„ÅåË©±„Åó„ÇÑ„Åô„ÅÑÈõ∞Âõ≤Ê∞ó„ÇíÁ∂≠ÊåÅ„Åß„Åç„Å¶„ÅÑ„Åæ„Åô„ÄÇ'
                    });
                }
                
                // ÊîπÂñÑÁÇπ„ÅÆÂàÜÊûêÔºà„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å´Ôºâ
                const improvements = [];
                if (whyQuestions < 3) {
                    improvements.push({
                        title: '„Äå„Å™„Åú„Äç„Çí„ÇÇ„Å£„Å®Ê¥ªÁî®',
                        detail: 'Ë°®Èù¢ÁöÑ„Å™‰∫ãÂÆü„Å†„Åë„Åß„Å™„Åè„ÄÅ„Åù„ÅÆËÉåÊôØ„Å´„ÅÇ„ÇãÁêÜÁî±„ÇÑÂãïÊ©ü„ÇíÊé¢„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        practice: '5 WhysÊâãÊ≥ïÔºö1„Å§„ÅÆÂõûÁ≠î„Å´ÂØæ„Åó„Å¶5Âõû„Äå„Å™„Åú„Äç„ÇíÁπ∞„ÇäËøî„Åó„ÄÅÊú¨Ë≥™ÁöÑ„Å™ÂéüÂõ†„Å´Âà∞ÈÅî„Åô„ÇãÁ∑¥Áøí„Çí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        examples: [
                            '„Äå„Å™„Åú„Åù„ÅÆÊñπÊ≥ï„ÇíÈÅ∏„Çì„Å†„ÅÆ„Åß„Åô„ÅãÔºü„Äç',
                            '„Äå„Åù„ÇÇ„Åù„ÇÇ„Å™„Åú„Åù„ÅÆÂïèÈ°å„ÅåËµ∑„Åç„Åü„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Äç',
                            '„Äå„Åù„ÅÆÊôÇ„Å™„Åú„Åù„ÅÜÊÑü„Åò„Åü„ÅÆ„Åã„ÄÅÁêÜÁî±„ÇíÊïô„Åà„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü„Äç'
                        ]
                    });
                }
                if (avgLength > 60) {
                    improvements.push({
                        title: 'Ë≥™Âïè„ÇíÁ∞°ÊΩî„Å´',
                        detail: `Âπ≥Âùá${Math.round(avgLength)}ÊñáÂ≠ó„ÅØÈï∑„Åô„Åé„Åæ„Åô„ÄÇÁõ∏Êâã„ÅåÁêÜËß£„Åó„ÇÑ„Åô„ÅÑ20-40ÊñáÂ≠óÁ®ãÂ∫¶„ÅÆË≥™Âïè„ÇíÂøÉ„Åå„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ`,
                        practice: 'Ë≥™Âïè„Çí‰Ωú„Å£„ÅüÂæå„ÄÅÂâä„Çå„ÇãË®ÄËëâ„Åå„Å™„ÅÑ„ÅãË¶ãÁõ¥„ÅôÁøíÊÖ£„Çí„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        examples: [
                            '‚ùå ÊÇ™„ÅÑ‰æãÔºö„ÄåÊôÆÊÆµ„ÅÆ‰ºëÊó•„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™ÊÑü„Åò„ÅßÈÅé„Åî„Åï„Çå„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„Åß„Åô„ÅãÔºü„Åæ„Åü„ÄÅÁêÜÊÉ≥ÁöÑ„Å™‰ºëÊó•„ÅÆÈÅé„Åî„ÅóÊñπ„Åå„ÅÇ„Çå„Å∞Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„Äç',
                            '‚úÖ ËâØ„ÅÑ‰æãÔºö„Äå‰ºëÊó•„ÅØ„Å©„ÅÜÈÅé„Åî„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü„Äç‚Üí„ÄåÁêÜÊÉ≥„ÅÆ‰ºëÊó•„ÅØÔºü„Äç'
                        ]
                    });
                }
                if (openQuestions < 5) {
                    improvements.push({
                        title: '„Ç™„Éº„Éó„É≥„ÇØ„Ç®„Çπ„ÉÅ„Éß„É≥„ÇíÂ¢ó„ÇÑ„Åô',
                        detail: 'Yes/No„ÅßÁ≠î„Åà„Çâ„Çå„ÇãË≥™Âïè„ÅåÂ§ö„ÅÑ„Åß„Åô„ÄÇÁõ∏Êâã„ÅåËá™Áî±„Å´Ë©±„Åõ„ÇãË≥™Âïè„ÇíÂ¢ó„ÇÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        practice: '„ÇØ„É≠„Éº„Ç∫„ÉâË≥™Âïè„Çí„Ç™„Éº„Éó„É≥Ë≥™Âïè„Å´Â§âÊèõ„Åô„ÇãÁ∑¥Áøí„Çí„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        examples: [
                            '‚ùå„ÄåÊ∫ÄË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü„Äç',
                            '‚úÖ„Äå„Å©„Çì„Å™ÁÇπ„Å´Ê∫ÄË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü„Äç',
                            '‚úÖ„Äå‰Ωï„Åå‰∏ÄÁï™„ÅÆË™≤È°å„Å†„Å®ÊÑü„Åò„Å¶„ÅÑ„Åæ„Åô„ÅãÔºü„Äç'
                        ]
                    });
                }
                if (avgScore < 50) {
                    improvements.push({
                        title: 'Áõ∏Êâã„ÅÆÊ∞óÊåÅ„Å°„Å´ÂØÑ„ÇäÊ∑ª„ÅÜ',
                        detail: 'Áõ∏Êâã„ÅÆÊÑüÊÉÖ„ÇÑÁä∂Ê≥Å„Å∏„ÅÆÂÖ±ÊÑü„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                        practice: 'ÂÖ±ÊÑü„ÇíÁ§∫„Åó„Å¶„Åã„ÇâË≥™Âïè„Åô„ÇãÁøíÊÖ£„Çí„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        examples: [
                            '„Äå„Åù„Çå„ÅØÂ§ßÂ§â„Åß„Åó„Åü„Å≠„ÄÇ„Åù„ÅÆÊôÇ„Å©„ÅÜÂØæÂá¶„Åï„Çå„Åü„Çì„Åß„Åô„ÅãÔºü„Äç',
                            '„Äå„Å™„Çã„Åª„Å©„ÄÅ„Äú„Å®„ÅÑ„ÅÜ„Åì„Å®„Åß„Åô„Å≠„ÄÇ„ÇÇ„ÅÜÂ∞ë„ÅóË©≥„Åó„ÅèÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„Äç',
                            '„ÄåÁ¢∫„Åã„Å´„Åù„ÅÆÊ∞óÊåÅ„Å°„Çè„Åã„Çä„Åæ„Åô„ÄÇ‰ªñ„Å´„ÇÇ‰ºº„ÅüÁµåÈ®ì„ÅØ„ÅÇ„Çä„Åæ„Åô„ÅãÔºü„Äç'
                        ]
                    });
                }
                
                // Ê¨°Âõû„ÅÆË™≤È°åÔºàÂÖ∑‰Ωì‰æã‰ªò„ÅçÔºâ
                const challenges = [];
                if (insights.length < 2) {
                    challenges.push({
                        title: 'Èö†„Çå„Åü„Éã„Éº„Ç∫„ÅÆÁô∫Ë¶ã',
                        approach: 'Áõ∏Êâã„ÅåÊòéË®Ä„Åó„Å¶„ÅÑ„Å™„ÅÑÊΩúÂú®ÁöÑ„Å™„Éã„Éº„Ç∫„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        techniques: [
                            'ÁêÜÊÉ≥„Å®ÁèæÂÆü„ÅÆ„ÇÆ„É£„ÉÉ„Éó„ÇíÊé¢„ÇãÔºö„ÄåÁêÜÊÉ≥ÁöÑ„Å´„ÅØ„Å©„ÅÜ„ÅÇ„Çä„Åü„ÅÑ„Åß„Åô„ÅãÔºü„Äç',
                            'ÊÑüÊÉÖ„ÅÆÂ§âÂåñ„Å´Ê≥®ÁõÆÔºö„Äå„Åù„ÅÆÂâçÂæå„ÅßÊ∞óÊåÅ„Å°„Å´Â§âÂåñ„ÅØ„ÅÇ„Çä„Åæ„Åó„Åü„ÅãÔºü„Äç',
                            'ÁüõÁõæ„ÇíÊ∑±Êéò„ÇäÔºö„ÄåÂÖà„Åª„Å©„Äú„Å®„Åä„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åó„Åü„Åå„ÄÅ‰ªä„ÅÆË©±„Å®ÈÅï„ÅÑ„Åå„ÅÇ„Çã„Çà„ÅÜ„Åß„Åô„ÅåÔºü„Äç'
                        ]
                    });
                }
                
                if (!bestQuestions.length || (bestQuestions[0] && bestQuestions[0].score < 85)) {
                    challenges.push({
                        title: '90ÁÇπË∂Ö„Åà„ÅÆË≥™Âïè„Å´ÊåëÊà¶',
                        approach: 'Êú¨Ë≥™ÁöÑ„Å™Ê∑±Êéò„Çä„Å®ÂÖ∑‰ΩìÊÄß„ÇíÁµÑ„ÅøÂêà„Çè„Åõ„ÅüË≥™Âïè„Çí‰Ωú„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                        techniques: [
                            '„Äå„Åù„ÇÇ„Åù„ÇÇ„Å™„Åú„Åù„ÅÆÁä∂Ê≥Å„Å´„Å™„Å£„Åü„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Åç„Å£„Åã„Åë„ÇíÂÖ∑‰ΩìÁöÑ„Å´Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„Äç',
                            '„Äå„Å™„Åú„Åù„Çå„Åå‰∏ÄÁï™ÈáçË¶Å„Å†„Å®ÊÑü„Åò„Çã„ÅÆ„Åß„Åô„ÅãÔºü‰ªñ„ÅÆÈÅ∏ÊäûËÇ¢„Å®ÊØî„Åπ„Å¶‰Ωï„ÅåÈÅï„ÅÑ„Åæ„Åó„Åü„ÅãÔºü„Äç',
                            '„Äå„Åù„ÅÆÂïèÈ°å„ÅÆÊ†πÊú¨ÂéüÂõ†„ÅØ‰Ωï„Å†„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Å™„Åú„Åù„ÅÜËÄÉ„Åà„Çã„ÅÆ„Åß„Åô„ÅãÔºü„Äç'
                        ]
                    });
                }
                
                challenges.push({
                    title: 'ÊÑüÊÉÖ„ÅÆÊ∑±Â±§„ÇíÊé¢„Çã',
                    approach: '‰∫ãÂÆü„Å†„Åë„Åß„Å™„Åè„ÄÅÊÑüÊÉÖ„Å®„Åù„ÅÆÁêÜÁî±„ÇíÊ∑±„ÅèÊéò„Çä‰∏ã„Åí„Åæ„Åó„Çá„ÅÜ„ÄÇ',
                    techniques: [
                        '„Äå„Åù„ÅÆÊôÇ„Å©„Çì„Å™Ê∞óÊåÅ„Å°„Åß„Åó„Åü„ÅãÔºü„Å™„Åú„Åù„ÅÜÊÑü„Åò„Åü„Å®ÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Äç',
                        '„Äå‰∏ÄÁï™Ëæõ„Åã„Å£„Åü/Â¨â„Åó„Åã„Å£„Åü„ÅÆ„ÅØ„Å©„Çì„Å™Áû¨Èñì„Åß„Åó„Åü„ÅãÔºü„Äç',
                        '„Äå„Åù„ÅÆÁµåÈ®ì„Åã„Çâ„ÄÅËá™ÂàÜ„Å´„Å§„ÅÑ„Å¶‰Ωï„ÅãÁô∫Ë¶ã„ÅØ„ÅÇ„Çä„Åæ„Åó„Åü„ÅãÔºü„Äç'
                    ]
                });
                
                return {
                    strengths,
                    improvements,
                    challenges,
                    stats: {
                        avgScore: Math.round(avgScore),
                        whyQuestions,
                        openQuestions,
                        avgLength: Math.round(avgLength),
                        totalInsights: insights.length
                    }
                };
            }, [scoreHistory, messages, comboCount, insights, bestQuestions]);
            
            // AIÂàÜÊûêÁî®„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
            const getAnalysisData = useCallback(() => {
                if (gameLogic?.getAnalysisData) {
                    return gameLogic.getAnalysisData(messages, scoreHistory, insights, questionCount);
                }
                return {
                    avgScore: 0,
                    whyQuestions: 0,
                    openQuestions: 0,
                    avgLength: 0,
                    totalInsights: insights.length
                };
            }, [gameLogic, messages, scoreHistory, insights, questionCount]);
            
            // „É°„Éã„É•„ÉºÁîªÈù¢
            const renderMenu = () => (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full fade-in relative">
                        {/* Ë®≠ÂÆö„Ç¢„Ç§„Ç≥„É≥ */}
                        <button
                            onClick={() => setShowApiSettings(true)}
                            className="absolute top-6 right-6 p-2 rounded-lg hover:bg-gray-100 transition-colors group"
                            title="APIË®≠ÂÆö"
                        >
                            <div className="relative">
                                <svg className="w-6 h-6 text-gray-600 group-hover:text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {/* APIË®≠ÂÆöÁä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
                                {apiTested ? (
                                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                                ) : (
                                    <div className="absolute -bottom-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                                )}
                            </div>
                        </button>
                        
                        <h1 className="text-4xl font-bold text-center mb-2 gradient-text">
                            „Éá„Ç∂„Ç§„É≥ÊÄùËÄÉ„Ç§„É≥„Çø„Éì„É•„Éº„Ç≤„Éº„É†
                        </h1>
                        <p className="text-gray-600 text-center mb-8">
                            AI„Éö„É´„ÇΩ„Éä„Å´„Ç§„É≥„Çø„Éì„É•„Éº„Åó„Å¶„ÄÅÈö†„Çå„Åü„Éã„Éº„Ç∫„ÇíÁô∫Ë¶ã„Åó„Çà„ÅÜÔºÅ
                        </p>
                        
                        <div className="space-y-6">
                            {/* Èõ£ÊòìÂ∫¶„Å®„ÉÅ„É£„É¨„É≥„Ç∏Ë®≠ÂÆö */}
                            <div>
                                <h3 className="text-lg font-semibold mb-3">üéÆ Èõ£ÊòìÂ∫¶Ë®≠ÂÆö</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                                    <button
                                        onClick={() => {
                                            setDifficulty('easy');
                                            setMaxQuestions(15);
                                            showToast('„Ç§„Éº„Ç∏„Éº„É¢„Éº„ÉâË®≠ÂÆö', 'info');
                                            console.log('Set Easy Mode: maxQuestions=15');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 15;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'easy' 
                                                ? 'border-green-500 bg-green-50' 
                                                : 'border-gray-200 hover:border-green-300'
                                        }`}
                                    >
                                        <div className="text-green-600 font-bold text-sm">„Ç§„Éº„Ç∏„Éº</div>
                                        <div className="text-xs text-gray-600">15Âïè„Åæ„Åß</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('normal');
                                            setMaxQuestions(10);
                                            showToast('„Éé„Éº„Éû„É´„É¢„Éº„ÉâË®≠ÂÆö', 'info');
                                            console.log('Set Normal Mode: maxQuestions=10');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 10;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'normal' 
                                                ? 'border-blue-500 bg-blue-50' 
                                                : 'border-gray-200 hover:border-blue-300'
                                        }`}
                                    >
                                        <div className="text-blue-600 font-bold text-sm">„Éé„Éº„Éû„É´</div>
                                        <div className="text-xs text-gray-600">10Âïè„Åæ„Åß</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('hard');
                                            setMaxQuestions(8);
                                            showToast('„Éè„Éº„Éâ„É¢„Éº„ÉâË®≠ÂÆö', 'warning');
                                            console.log('Set Hard Mode: maxQuestions=8');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 8;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'hard' 
                                                ? 'border-orange-500 bg-orange-50' 
                                                : 'border-gray-200 hover:border-orange-300'
                                        }`}
                                    >
                                        <div className="text-orange-600 font-bold text-sm">„Éè„Éº„Éâ</div>
                                        <div className="text-xs text-gray-600">8Âïè„Åæ„Åß</div>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setDifficulty('expert');
                                            setMaxQuestions(6);
                                            showToast('‚ö° „Ç®„Ç≠„Çπ„Éë„Éº„Éà„É¢„Éº„ÉâËµ∑ÂãïÔºÅ', 'error');
                                            console.log('Set Expert Mode: maxQuestions=6');
                                            if (typeof window !== 'undefined') {
                                                window.__DEBUG_MAX_QUESTIONS = 6;
                                            }
                                        }}
                                        className={`p-2 rounded-lg border-2 transition-all ${
                                            difficulty === 'expert' 
                                                ? 'border-red-500 bg-red-50 animate-pulse' 
                                                : 'border-gray-200 hover:border-red-300'
                                        }`}
                                    >
                                        <div className="text-red-600 font-bold text-sm">„Ç®„Ç≠„Çπ„Éë„Éº„Éà</div>
                                        <div className="text-xs text-gray-600">6Âïè„Åæ„Åß</div>
                                    </button>
                                </div>
                                
                                {/* „ÉÅ„É£„É¨„É≥„Ç∏„Éü„ÉÉ„Ç∑„Éß„É≥ */}
                                {difficulty === 'expert' && (
                                    <div className="p-3 bg-gradient-to-r from-red-50 to-orange-50 rounded-lg mb-3 fade-in">
                                        <div className="text-sm font-bold text-red-700 mb-2">üèÜ „Ç®„Ç≠„Çπ„Éë„Éº„Éà„ÉÅ„É£„É¨„É≥„Ç∏</div>
                                        <div className="grid gap-2">
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setChallengeMode(e.target.checked ? 'noHint' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">„Éé„Éº„Éí„É≥„Éà„É¢„Éº„Éâ („Çπ„Ç≥„Ç¢√ó1.5)</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setCurrentMission(e.target.checked ? 'speedrun' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">„Çπ„Éî„Éº„Éâ„É©„É≥ - 3ÂàÜ‰ª•ÂÜÖ„ÇØ„É™„Ç¢ („Çπ„Ç≥„Ç¢√ó2)</span>
                                            </label>
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    onChange={(e) => setCurrentMission(e.target.checked ? 'perfect' : null)}
                                                    className="mr-2"
                                                />
                                                <span className="text-xs">„Éë„Éº„Éï„Çß„ÇØ„Éà„É©„É≥ - ÂÖ®Ë≥™Âïè70ÁÇπ‰ª•‰∏ä (ÁâπÂà•Áß∞Âè∑)</span>
                                            </label>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div>
                                <h3 className="text-lg font-semibold mb-3">1. „ÉÜ„Éº„Éû„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÈÅ∏Êäû</h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {themeCategories.map(cat => (
                                        <button
                                            key={cat.id}
                                            onClick={async () => {
                                                if (!isGeneratingPainPoints) {
                                                    setSelectedCategory(cat.id);
                                                    setIsGeneratingPainPoints(true);
                                                    try {
                                                        const points = await generatePainPoints(cat.id);
                                                        if (points && points.length > 0) {
                                                            setPainPoints(points);
                                                        } else {
                                                            // Empty result, clear selection to allow retry
                                                            setSelectedCategory(null);
                                                            setPainPoints([]);
                                                        }
                                                    } catch (error) {
                                                        console.error('All retries failed:', error);
                                                        // Reset selection to allow user to try again
                                                        setSelectedCategory(null);
                                                        setPainPoints([]);
                                                    } finally {
                                                        setIsGeneratingPainPoints(false);
                                                    }
                                                }
                                            }}
                                            disabled={isGeneratingPainPoints}
                                            className={`p-4 rounded-lg border-2 transition-all ${
                                                isGeneratingPainPoints 
                                                    ? 'opacity-50 cursor-not-allowed' 
                                                    : 'card-shadow-hover'
                                            } ${
                                                selectedCategory === cat.id 
                                                    ? 'border-purple-500 bg-purple-50' 
                                                    : 'border-gray-200 hover:border-purple-300'
                                            }`}
                                        >
                                            <div className="text-2xl mb-1">{cat.icon}</div>
                                            <div className="font-medium text-sm">{cat.title}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* „Éö„Ç§„É≥„Éù„Ç§„É≥„ÉàÁîüÊàê‰∏≠„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞ */}
                            {isGeneratingPainPoints && (
                                <div className="fade-in">
                                    <div className="flex items-center justify-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
                                        <span className="ml-3 text-gray-600">„ÅäÈ°å„ÇíÁîüÊàê‰∏≠...</span>
                                    </div>
                                </div>
                            )}
                            
                            {selectedCategory && painPoints.length > 0 && !isGeneratingPainPoints && (
                                <div className="fade-in">
                                    <h3 className="text-lg font-semibold mb-3">2. Âõ∞„Çä„Åî„Å®„ÇíÈÅ∏Êäû</h3>
                                    <div className="space-y-2">
                                        {painPoints.map((point, index) => (
                                            <button
                                                key={index}
                                                onClick={() => setSelectedPainPoint(point)}
                                                className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                                                    selectedPainPoint === point
                                                        ? 'border-purple-500 bg-purple-50'
                                                        : 'border-gray-200 hover:border-purple-300'
                                                }`}
                                            >
                                                <div className="font-medium">{point}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            <div>
                                <h3 className="text-lg font-semibold mb-3">„Ç´„Çπ„Çø„É†Âõ∞„Çä„Åî„Å®</h3>
                                <input
                                    type="text"
                                    value={customPainPoint}
                                    onChange={(e) => {
                                        setCustomPainPoint(e.target.value);
                                        setSelectedPainPoint(''); // „Ç´„Çπ„Çø„É†ÂÖ•ÂäõÊôÇ„ÅØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
                                    }}
                                    placeholder="ÂÖ∑‰ΩìÁöÑ„Å™Âõ∞„Çä„Åî„Å®„ÇíÂÖ•ÂäõÔºà‰æãÔºö„Éê„Çπ„Å´‰πó„Çã„ÅÆ„ÅåËã¶Êâã„ÅßÂõ∞„Å£„Å¶„ÅÑ„ÇãÔºâ"
                                    className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={startGame}
                                    disabled={!apiTested || isGeneratingPersona}
                                    className={`w-full py-3 px-6 rounded-lg font-medium transition-all transform ${
                                        apiTested && !isGeneratingPersona
                                            ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 hover:scale-105' 
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    {isGeneratingPersona ? '„Éö„É´„ÇΩ„ÉäÁîüÊàê‰∏≠...' : apiTested ? '„Ç≤„Éº„É†ÈñãÂßã' : 'API„ÉÜ„Çπ„Éà„ÅåÂøÖË¶Å'}
                                </button>
                            </div>
                            
                        </div>
                    </div>
                    
                    {/* APIË®≠ÂÆö„É¢„Éº„ÉÄ„É´ */}
                    {showApiSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                                <h2 className="text-xl font-bold mb-4">APIË®≠ÂÆö</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">OpenRouter API„Ç≠„Éº</label>
                                        <input
                                            type="password"
                                            value={apiKey}
                                            onChange={(e) => {
                                                setApiKey(e.target.value);
                                                setApiTested(false);
                                            }}
                                            placeholder="sk-or-..."
                                            className="w-full p-2 border rounded focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">„É¢„Éá„É´</label>
                                        <select
                                            value={apiModel}
                                            onChange={(e) => {
                                                setApiModel(e.target.value);
                                                setApiTested(false);
                                            }}
                                            className="w-full p-2 border rounded focus:border-purple-500 focus:outline-none"
                                        >
                                            <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek Chat V3.1 (Free)</option>
                                            <option value="openrouter/sonoma-sky-alpha">Sonoma Sky Alpha (Free)</option>
                                            <option value="deepseek/deepseek-chat-v3-0324:free">DeepSeek Chat V3 (Free)</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button
                                            onClick={testAPI}
                                            disabled={apiTesting}
                                            className={`flex-1 py-2 px-4 rounded-lg font-medium transition-all ${
                                                apiTested
                                                    ? 'bg-green-500 text-white hover:bg-green-600'
                                                    : !apiKey
                                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                        : 'bg-blue-500 text-white hover:bg-blue-600'
                                            }`}
                                        >
                                            {apiTesting ? '„ÉÜ„Çπ„Éà‰∏≠...' : apiTested ? '‚úì Êé•Á∂öÊàêÂäü' : 'API„Çí„ÉÜ„Çπ„Éà'}
                                        </button>
                                        {apiTested && (
                                            <button
                                                onClick={() => setShowApiSettings(false)}
                                                className="py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                                            >
                                                Èñâ„Åò„Çã
                                            </button>
                                        )}
                                    </div>
                                    {!apiTested && (
                                        <p className="text-xs text-red-500">
                                            ‚ÄªAPI„ÉÜ„Çπ„Éà„Å´ÊàêÂäü„Åô„Çã„Åæ„Åß„Ç≤„Éº„É†„ÇíÈñãÂßã„Åß„Åç„Åæ„Åõ„Çì
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
            
            // „Ç≤„Éº„É†ÁîªÈù¢
            const renderGame = () => {
                console.log('renderGame - messages:', messages);
                console.log('renderGame - messages length:', messages.length);

                const remainingQuestions = Math.max(maxQuestions - questionCount, 0);
                const personaName = persona?.name || '„Ç≤„Çπ„Éà';
                const moodEmoji = mood === 'open' ? 'üòä' : mood === 'normal' ? 'üòê' : mood === 'guard' ? 'üòî' : mood === 'close' ? 'üò§' : 'üôÇ';
                const moodLabel = mood === 'open' ? 'ÈñãÊîæÁöÑ' : mood === 'normal' ? 'ÊôÆÈÄö' : mood === 'guard' ? 'Ë≠¶Êàí' : mood === 'close' ? 'ÈñâÈéñÁöÑ' : 'ÂÆâÂÆö';
                const moodDisplay = `${moodEmoji} ${moodLabel}`.trim();

                if (isMobile) {
                    return (
                        <div className="mobile-chat-shell">
                            <header className="mobile-chat-header">
                                <div className="mobile-chat-header-top">
                                    <div>
                                        <div className="mobile-chat-title">ÁèæÂú®„ÅÆ„Çπ„Ç≥„Ç¢</div>
                                        <div className="mobile-chat-score">
                                            {currentScore}
                                            <span className="ml-1 text-sm font-semibold text-indigo-400">ÁÇπ</span>
                                        </div>
                                    </div>
                                    <div className="mobile-header-actions">
                                        <button
                                            type="button"
                                            onClick={() => setShowPersonaInfo(!showPersonaInfo)}
                                            className="mobile-header-button"
                                        >
                                            <span role="img" aria-hidden="true">üë§</span>
                                            „Éö„É´„ÇΩ„Éä
                                        </button>
                                    </div>
                                </div>
                                <div className="mobile-chat-meta">
                                    <div className="mobile-chip">
                                        <span>Áõ∏Êâã</span>
                                        <strong>{personaName}</strong>
                                    </div>
                                    <div className="mobile-chip">
                                        <span>Ë≥™Âïè</span>
                                        <strong>{questionCount}/{maxQuestions}</strong>
                                    </div>
                                    <div className="mobile-chip">
                                        <span>ÊÆã„Çä</span>
                                        <strong>{remainingQuestions}</strong>
                                    </div>
                                    <div className="mobile-chip">
                                        <span>Ê∞óÂàÜ</span>
                                        <strong>{moodDisplay}</strong>
                                    </div>
                                </div>
                                <div className="mobile-meter">
                                    <span className="mobile-meter-label">Ë©±„Åó„Åü„ÅÑÂ∫¶</span>
                                    <div className="mobile-meter-track">
                                        <div className="mobile-meter-fill" style={{ width: `${talkMeter}%` }} />
                                    </div>
                                </div>
                            </header>

                            {showPersonaInfo && persona && (
                                <>
                                    <div className="mobile-persona-overlay" onClick={() => setShowPersonaInfo(false)} />
                                    <div className="mobile-persona-modal">
                                        <div className="flex justify-between items-center mb-3">
                                            <h3 className="text-lg font-bold">„Éö„É´„ÇΩ„ÉäÊÉÖÂ†±</h3>
                                            <button
                                                onClick={() => setShowPersonaInfo(false)}
                                                className="p-1 rounded-full hover:bg-gray-100"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">ÂêçÂâç:</span>
                                                <span className="font-medium">{persona.name}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">Âπ¥ÈΩ¢:</span>
                                                <span className="font-medium">{persona.age}Ê≠≥ / {persona.gender}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">ËÅ∑Ê•≠:</span>
                                                <span className="font-medium">{persona.job}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">Â±Ö‰ΩèÂú∞:</span>
                                                <span className="font-medium">{persona.location}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">ÂÆ∂Êóè:</span>
                                                <span className="font-medium">{persona.family}</span>
                                            </div>
                                            {persona.currentSituation && (
                                                <div className="pt-2 mt-2 border-t">
                                                    <div className="text-gray-500 mb-1">ÁèæÂú®„ÅÆÁä∂Ê≥Å:</div>
                                                    <div className="text-xs">{persona.currentSituation}</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </>
                            )}

                            <div className="mobile-chat-scroll-wrapper">
                                <div
                                    ref={chatAreaRef}
                                    className="mobile-chat-scroll"
                                    onScroll={handleScroll}
                                >
                                    <div className="space-y-3">
                                        {messages.map((msg, index) => (
                                            <div
                                                key={index}
                                                className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}
                                            >
                                                <div className={`message-bubble ${msg.type === 'system' ? 'ai' : msg.type}`}>
                                                    <div>{msg.content}</div>
                                                    {msg.score !== undefined && (
                                                        <div className="mt-2 text-[11px] opacity-70">
                                                            „Çπ„Ç≥„Ç¢: {msg.score}ÁÇπ
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                        {isTyping && (
                                            <div className="flex justify-start">
                                                <div className="message-bubble ai flex gap-1 items-center">
                                                    <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                                    <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                                    <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                                </div>
                                            </div>
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>
                                </div>
                                {!shouldAutoScroll && (
                                    <button
                                        type="button"
                                        onClick={scrollToLatest}
                                        className="mobile-scroll-to-bottom"
                                        aria-label="ÊúÄÊñ∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å∏"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v14m0 0l6-6m-6 6l-6-6" />
                                        </svg>
                                    </button>
                                )}
                            </div>

                            <div className="mobile-chat-compose">
                                <div className="mobile-composer-fieldset">
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        value={currentQuestion}
                                        onChange={(e) => setCurrentQuestion(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                handleSubmitQuestion();
                                            }
                                        }}
                                        placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ..."
                                        disabled={questionCount >= maxQuestions}
                                        autoComplete="off"
                                        autoCorrect="off"
                                        autoCapitalize="off"
                                        spellCheck="false"
                                        className="mobile-composer-input"
                                    />
                                    <button
                                        type="button"
                                        onClick={handleSubmitQuestion}
                                        disabled={!currentQuestion.trim() || questionCount >= maxQuestions}
                                        className="mobile-send-button"
                                    >
                                        ÈÄÅ‰ø°
                                    </button>
                                </div>
                                {comboCount > 0 && (
                                    <div className="mobile-combo-indicator">
                                        üî• {comboCount}„Ç≥„É≥„ÉúÔºÅ
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="min-h-screen flex flex-col">
                        <div className="bg-white shadow-lg p-4">
                            <div className="max-w-6xl mx-auto">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <div className="text-sm text-gray-500 mb-1">Ë©±„Åó„Åü„ÅÑÂ∫¶</div>
                                        <div className="progress-bar">
                                            <div
                                                className={`progress-bar-fill bg-gradient-to-r ${getMoodColor()}`}
                                                style={{ width: `${talkMeter}%` }}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-500 mb-1">„Çπ„Ç≥„Ç¢</div>
                                        <div className="text-2xl font-bold">
                                            {currentScore}
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">ÁÇπ</div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-500 mb-1">ÊÆã„ÇäË≥™Âïè</div>
                                        <div className="flex gap-1">
                                            {[...Array(maxQuestions)].map((_, i) => (
                                                <div
                                                    key={i}
                                                    className={`w-3 h-3 rounded-full ${
                                                        i < questionCount ? 'bg-gray-300' : 'bg-purple-500'
                                                    }`}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <div className="text-sm text-gray-500 mb-1">Ê∞óÂàÜ</div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-2xl">{moodEmoji}</span>
                                            <span className="text-xs text-gray-600">{moodLabel}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-3 flex justify-between items-center">
                                    <button
                                        onClick={() => setShowPersonaInfo(!showPersonaInfo)}
                                        className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg text-sm font-medium hover:from-blue-600 hover:to-purple-600 transition-all"
                                    >
                                        {showPersonaInfo ? 'üë§ „Éö„É´„ÇΩ„ÉäÊÉÖÂ†±„ÇíÈö†„Åô' : 'üë§ „Éö„É´„ÇΩ„ÉäÊÉÖÂ†±„ÇíË¶ã„Çã'}
                                    </button>
                                    <div className="text-sm text-gray-600">
                                        Áõ∏Êâã: <strong>{persona?.name}</strong> ({persona?.age}Ê≠≥ / {persona?.job})
                                    </div>
                                </div>
                            </div>
                        </div>

                        {showPersonaInfo && persona && (
                            <div className="mt-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200 fade-in">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div>
                                        <div className="text-xs text-gray-500">ÂêçÂâç</div>
                                        <div className="font-medium">{persona.name}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">Âπ¥ÈΩ¢„ÉªÊÄßÂà•</div>
                                        <div className="font-medium">{persona.age}Ê≠≥ / {persona.gender}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">ËÅ∑Ê•≠</div>
                                        <div className="font-medium">{persona.job}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">Â±Ö‰ΩèÂú∞</div>
                                        <div className="font-medium">{persona.location}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">ÂÆ∂Êóè</div>
                                        <div className="font-medium">{persona.family}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500">Ë∂£Âë≥</div>
                                        <div className="font-medium">{persona.hobbies?.join('„ÄÅ')}</div>
                                    </div>
                                    {persona.personality?.traits && (
                                        <div className="md:col-span-2">
                                            <div className="text-xs text-gray-500">ÊÄßÊ†º</div>
                                            <div className="font-medium">{persona.personality.traits.join('„ÄÅ')}</div>
                                        </div>
                                    )}
                                </div>
                                {persona.currentSituation && (
                                    <div className="mt-3 p-3 bg-white rounded">
                                        <div className="text-xs text-gray-500 mb-1">ÁèæÂú®„ÅÆÁä∂Ê≥Å</div>
                                        <div className="text-sm">{persona.currentSituation}</div>
                                    </div>
                                )}
                            </div>
                        )}

                        {bestQuestions.length > 0 && (
                            <div className="mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                <div className="text-sm font-bold text-purple-700 mb-2">üèÜ ÂÑ™ÁßÄ„Å™Ë≥™Âïè</div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    {bestQuestions.slice(0, 3).map((q, i) => (
                                        <div key={i} className="bg-white p-2 rounded text-xs">
                                            <div className="font-medium text-gray-800 truncate">„Äå{q.question}„Äç</div>
                                            <div className="text-purple-600 font-bold">{q.score}ÁÇπ</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {questionCount > 2 && scoreHistory.length > 0 && (
                            <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                                <div className="text-xs text-blue-800">
                                    üí° „Éí„É≥„Éà: 
                                    {scoreHistory[scoreHistory.length - 1] < 50 ?
                                        '„Äå„Å™„Åú„Äç„Äå„Å©„ÅÜ„Åó„Å¶„Äç„Çí‰Ωø„Å£„Å¶Ê∑±Êéò„Çä„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ' :
                                     scoreHistory[scoreHistory.length - 1] < 70 ?
                                        'ÂÖ∑‰ΩìÁöÑ„Å™„Ç®„Éî„ÇΩ„Éº„Éâ„ÇíËÅû„ÅÑ„Å¶„Åø„Åæ„Åó„Çá„ÅÜ' :
                                        'Á¥†Êô¥„Çâ„Åó„ÅÑË≥™Âïè„Åß„ÅôÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÁ∂ö„Åë„Åæ„Åó„Çá„ÅÜ'}
                                </div>
                            </div>
                        )}

                        <div className="relative flex-1">
                            <div
                                ref={chatAreaRef}
                                className="h-full overflow-y-auto p-4 bg-gray-50"
                                onScroll={handleScroll}
                            >
                                <div className="max-w-4xl mx-auto space-y-3">
                                    {messages.map((msg, index) => (
                                        <div
                                            key={index}
                                            className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'} fade-in`}
                                        >
                                            <div className={`message-bubble ${msg.type}`}>
                                                <div>{msg.content}</div>
                                                {msg.score !== undefined && (
                                                    <div className="mt-2 text-xs opacity-70">
                                                        „Çπ„Ç≥„Ç¢: {msg.score}ÁÇπ
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && (
                                        <div className="flex justify-start">
                                            <div className="message-bubble ai flex gap-1 items-center">
                                                <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                                <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                                <span className="typing-dot inline-block w-2 h-2 bg-gray-400 rounded-full"></span>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>
                            </div>

                            {!shouldAutoScroll && (
                                <button
                                    onClick={scrollToLatest}
                                    className="absolute bottom-4 right-4 bg-purple-500 text-white p-3 rounded-full shadow-lg hover:bg-purple-600 transition-all transform hover:scale-110 animate-bounce"
                                    aria-label="ÊúÄÊñ∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å∏"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                    </svg>
                                </button>
                            )}
                        </div>

                        <div className="bg-white border-t p-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex gap-2">
                                    <input
                                        ref={inputRef}
                                        type="text"
                                        value={currentQuestion}
                                        onChange={(e) => setCurrentQuestion(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                handleSubmitQuestion();
                                            }
                                        }}
                                        placeholder="Ë≥™Âïè„ÇíÂÖ•Âäõ..."
                                        disabled={questionCount >= maxQuestions}
                                        autoComplete="off"
                                        autoCorrect="off"
                                        autoCapitalize="off"
                                        spellCheck="false"
                                        className="flex-1 p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors disabled:bg-gray-100"
                                    />
                                    <button
                                        onClick={handleSubmitQuestion}
                                        disabled={!currentQuestion.trim() || questionCount >= maxQuestions}
                                        className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105"
                                    >
                                        ÈÄÅ‰ø°
                                    </button>
                                </div>
                                {comboCount > 0 && (
                                    <div className="mt-2 text-center text-purple-600 font-bold bounce">
                                        üî• {comboCount}„Ç≥„É≥„ÉúÔºÅ
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };
            
            // AI„Å´„Çà„Çã‰ºöË©±ÂàÜÊûêÁîüÊàê
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const generateAIAnalysis = useCallback(async () => {
                console.log('generateAIAnalysis called', { apiKey: !!apiKey, messagesLength: messages.length });
                if (!apiKey || messages.length === 0) {
                    console.log('Skipping AI analysis - no API key or messages');
                    return;
                }
                
                setIsTyping(true);
                showToast('‰ºöË©±„ÇíÂàÜÊûê‰∏≠...', 'info');
                
                const conversationHistory = messages.map(m => 
                    `${m.type === 'user' ? '„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº' : persona.name}: ${m.content}${m.score ? ` („Çπ„Ç≥„Ç¢: ${m.score}ÁÇπ)` : ''}`
                ).join('\n');
                
                const analysisPrompt = `„ÅÇ„Å™„Åü„ÅØ„Ç§„É≥„Çø„Éì„É•„ÉºÊäÄË°ì„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ
‰ª•‰∏ã„ÅÆ„Ç§„É≥„Çø„Éì„É•„Éº‰ºöË©±„ÇíÂàÜÊûê„Åó„ÄÅ„Ç§„É≥„Çø„Éì„É•„Ç¢„ÉºÔºàË≥™ÂïèËÄÖÔºâ„ÅÆÊäÄË°ì„ÇíË©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÈáçË¶Å: „Åì„Çå„ÅØ„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆË≥™ÂïèÊäÄË°ì„ÇíÂêë‰∏ä„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆÂàÜÊûê„Åß„Åô„ÄÇ
„Ç§„É≥„Çø„Éì„É•„Éº„Åï„Çå„ÅüÂÅ¥Ôºà${persona.name}Ôºâ„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ

„ÉÜ„Éº„Éû: ${persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'Âõ∞„Çä„Åî„Å®'}
„Éö„É´„ÇΩ„Éä: ${persona.name} (${persona.age}Ê≠≥, ${persona.job})

‰ºöË©±Â±•Ê≠¥:
${conversationHistory}

„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆË≥™ÂïèÊäÄË°ì„Å´„Å§„ÅÑ„Å¶„ÄÅ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
ÈáçË¶Å: Á∞°ÊΩî„Å´Ë¶ÅÁÇπ„Çí„Åæ„Å®„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ:

{
  "strengths": [
    {
      "title": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆÂº∑„ÅøÔºàÁ∞°ÊΩî„Å´Ôºâ",
      "detail": "ÂÖ∑‰ΩìÁöÑ„Å´„Å©„ÅÆË≥™Âïè„ÅåËâØ„Åã„Å£„Åü„Åã„ÄÅ„Å™„ÅúËâØ„Åã„Å£„Åü„Åã„ÇíË©≥„Åó„ÅèË™¨Êòé"
    }
  ],
  "improvements": [
    {
      "title": "ÊîπÂñÑ„Åô„Åπ„ÅçÁÇπÔºàÁ∞°ÊΩî„Å´Ôºâ",
      "detail": "„Å©„ÅÆË≥™Âïè„ÅÆ„Å©„Åì„ÅåÂïèÈ°å„Å†„Å£„Åü„Åã„ÄÅ„Å©„ÅÜÊîπÂñÑ„Åô„Åπ„Åç„ÅãÂÖ∑‰ΩìÁöÑ„Å´Ë™¨Êòé",
      "practice": "ÂÆüË∑µÁöÑ„Å™Á∑¥ÁøíÊñπÊ≥ï„ÇíÂÖ∑‰ΩìÁöÑ„Å´Ë™¨Êòé",
      "examples": ["ÊîπÂñÑ„Åï„Çå„ÅüË≥™Âïè‰æã„Çí2-3ÂÄã", "Âà•„ÅÆ„Ç¢„Éó„É≠„Éº„ÉÅ‰æã"]
    }
  ],
  "bestQuestion": {
    "question": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅåË°å„Å£„ÅüÊúÄ„ÇÇÂÑ™„Çå„ÅüË≥™Âïè",
    "reason": "„Å™„Åú„Åù„ÅÆË≥™Âïè„ÅåÂÑ™„Çå„Å¶„ÅÑ„Åü„Åã"
  },
  "worstQuestion": {
    "question": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆÊúÄ„ÇÇÊîπÂñÑ„ÅåÂøÖË¶Å„Å™Ë≥™Âïè",
    "improvement": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅØ„Åì„ÅÜËÅû„Åè„Åπ„Åç„Å†„Å£„Åü"
  },
  "insights": ["„Ç§„É≥„Çµ„Ç§„Éà1", "„Ç§„É≥„Çµ„Ç§„Éà2", "„Ç§„É≥„Çµ„Ç§„Éà3"],
  "overallFeedback": "Á∑èÂêàÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºà100-150ÊñáÂ≠óÁ®ãÂ∫¶Ôºâ",
  "nextChallenge": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅåÊ¨°ÂõûÊåëÊà¶„Åô„Åπ„ÅçÂÖ∑‰ΩìÁöÑ„Å™Ë™≤È°å",
  "missedOpportunities": [
    {
      "moment": "ËÅû„ÅçÈÄÉ„Åó„ÅüÈáçË¶Å„Å™Áû¨Èñì",
      "whatToAsk": "„Åù„ÅÆÊôÇËÅû„Åè„Åπ„Åç„Å†„Å£„ÅüË≥™Âïè",
      "reason": "„Å™„Åú„Åù„Çå„ÅåÈáçË¶Å„Å†„Å£„Åü„Åã"
    }
  ],
  "emotionalIntelligence": {
    "score": 80,
    "feedback": "Áõ∏Êâã„ÅÆÊÑüÊÉÖ„Å∏„ÅÆÈÖçÊÖÆ„Å´„Å§„ÅÑ„Å¶„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ"
  },
  "questioningTechniques": {
    "openQuestions": "„Ç™„Éº„Éó„É≥Ë≥™Âïè„ÅÆ‰Ωø„ÅÑÊñπË©ï‰æ°",
    "followUp": "„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóË≥™Âïè„ÅÆË©ï‰æ°", 
    "probing": "Ê∑±Êéò„ÇäË≥™Âïè„ÅÆË©ï‰æ°"
  },
  "stats": {
    "avgScore": 50,
    "whyQuestions": 3,
    "openQuestions": 5,
    "avgLength": 30,
    "totalInsights": 2
  },
  "challenges": [
    {
      "title": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅåÊåëÊà¶„Åô„Åπ„ÅçË™≤È°å",
      "approach": "„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅåÂèñ„Çã„Åπ„Åç„Ç¢„Éó„É≠„Éº„ÉÅÊñπÊ≥ï",
      "techniques": ["„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅåÁøíÂæó„Åô„Åπ„ÅçÂÖ∑‰ΩìÁöÑ„Å™„ÉÜ„ÇØ„Éã„ÉÉ„ÇØ"]
    }
  ]
}

Ê≥®ÊÑè: „Åô„Åπ„Å¶„ÅÆÂàÜÊûê„ÅØ„Ç§„É≥„Çø„Éì„É•„Ç¢„Éº„ÅÆÊäÄË°ìÂêë‰∏ä„ÅÆ„Åü„ÇÅ„ÅÆ„ÇÇ„ÅÆ„Åß„Åô„ÄÇ
${persona.name}„Å∏„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`;
                
                // „É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØ
                const maxRetries = 3;
                let retryCount = 0;
                let lastError = null;
                
                while (retryCount < maxRetries) {
                    try {
                        const analysisModel = apiModel || 'deepseek/deepseek-chat-v3.1:free';
                        
                        console.log('Generating analysis with model:', analysisModel);
                        
                        // „É™„Éà„É©„Ç§ÊôÇ„ÅØ„Éó„É≠„É≥„Éó„Éà„ÇíÊîπÂñÑ
                        const retryPromptSuffix = retryCount > 0 ? 
                            '\n\nÈáçË¶Å: ÂøÖ„ÅöÂÆåÂÖ®„ÅßÊúâÂäπ„Å™JSONÂΩ¢Âºè„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSON„ÅÆ„Åø„ÇíËøî„Åó„ÄÅË™¨ÊòéÊñá„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇÈÖçÂàó„ÅåÁ©∫„ÅÆÂ†¥Âêà„Åß„ÇÇ[]„Å®Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊñáÂ≠óÂàó„ÅØÂøÖ„Åö""„ÅßÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ' : '';
                        
                        const response = await safariFetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin || 'http://localhost',
                                'X-Title': 'Interview Game Analysis'
                            },
                            body: JSON.stringify({
                                model: analysisModel,
                                messages: [
                                    { 
                                        role: 'system', 
                                        content: '„ÅÇ„Å™„Åü„ÅØ„Ç§„É≥„Çø„Éì„É•„ÉºÂàÜÊûê„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ‰∏é„Åà„Çâ„Çå„Åü‰ºöË©±„ÇíÂàÜÊûê„Åó„ÄÅÂøÖ„ÅöÂÆåÂÖ®„ÅßÊúâÂäπ„Å™JSONÂΩ¢Âºè„ÅÆ„Åø„ÅßÂøúÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇË™¨ÊòéÊñá„ÇÑËøΩÂä†„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØÂê´„ÇÅ„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇJSON„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£Âêç„ÅØÂøÖ„Åö„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÅßÂõ≤„Åø„ÄÅÊñáÂ≠óÂàóÂÄ§„ÇÇ„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà„ÅßÂõ≤„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇÈÖçÂàó„ÇÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÊúÄÂæå„ÅÆË¶ÅÁ¥†„Å´„Ç´„É≥„Éû„Çí‰ªò„Åë„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ' 
                                    },
                                    { role: 'user', content: analysisPrompt + retryPromptSuffix }
                                ],
                                temperature: 0.5,
                                max_tokens: analysisModel === 'openrouter/sonoma-sky-alpha' ? 8000 : 4000 // Sonoma: 8000, DeepSeek: 4000
                            })
                        }, 30000); // 30 second timeout for analysis
                        
                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                            throw new Error('Invalid API response structure');
                        }
                        
                        const content = data.choices[0].message.content;
                        
                        // JSON„Éë„Éº„ÇπÂá¶ÁêÜ
                        try {
                            let jsonStr = content;
                            
                            // „Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÇíÈô§Âéª
                            jsonStr = jsonStr.replace(/```json\n?|```\n?|```/g, '');
                            
                            // JSON„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊäΩÂá∫
                            const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                jsonStr = jsonMatch[0];
                            }
                            
                            // ‰∏ÄËà¨ÁöÑ„Å™JSON„Ç®„É©„Éº„Çí‰øÆÊ≠£
                            jsonStr = jsonStr
                                .replace(/,\s*\}/g, '}') // Êú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                                .replace(/,\s*\]/g, ']') // ÈÖçÂàóÊú´Â∞æ„ÅÆ„Ç´„É≥„Éû„ÇíÂâäÈô§
                                .replace(/([\[\{,])\s*,/g, '$1') // ÈÄ£Á∂ö„Ç´„É≥„Éû„ÇíÂâäÈô§
                                .replace(/\n\s*\n/g, '\n') // Á©∫Ë°å„ÇíÂâäÈô§
                                .replace(/[\u0000-\u001F\u007F-\u009F]/g, ''); // Âà∂Âæ°ÊñáÂ≠ó„ÇíÂâäÈô§
                            
                            // ‰∏çÂÆåÂÖ®„Å™JSON„ÅÆ‰øÆÂæ©
                            if (jsonStr.includes('...') || jsonStr.length < 50) {
                                throw new Error('Incomplete JSON response');
                            }
                            
                            const parsedAnalysis = JSON.parse(jsonStr);
                            
                            // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆÊ§úË®º
                            if (!parsedAnalysis.strengths || !parsedAnalysis.improvements) {
                                throw new Error('Missing required fields in analysis');
                            }
                            
                            // stats„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆö
                            if (!parsedAnalysis.stats) {
                                const analysisData = getAnalysisData();
                                parsedAnalysis.stats = analysisData;
                            }
                            
                            // ÈÖçÂàó„ÅÆÊ§úË®º„ÇíËøΩÂä†
                            const validatedAnalysis = {
                                ...parsedAnalysis,
                                strengths: Array.isArray(parsedAnalysis.strengths) ? parsedAnalysis.strengths : [],
                                improvements: Array.isArray(parsedAnalysis.improvements) ? parsedAnalysis.improvements : [],
                                insights: Array.isArray(parsedAnalysis.insights) ? parsedAnalysis.insights : [],
                                challenges: Array.isArray(parsedAnalysis.challenges) ? parsedAnalysis.challenges : []
                            };
                            
                            setAiAnalysis(validatedAnalysis);
                            console.log('AI Analysis parsed successfully:', validatedAnalysis);
                            showToast('ÂàÜÊûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success');
                            break; // ÊàêÂäü„Åó„Åü„Çâ„É´„Éº„Éó„ÇíÊäú„Åë„Çã
                            
                        } catch (parseError) {
                            lastError = parseError;
                            console.error(`Parse attempt ${retryCount + 1} failed:`, parseError);
                            console.error('Raw content:', content);
                            console.error('Cleaned JSON:', jsonStr);
                            
                            // „Éá„Éê„ÉÉ„Ç∞: JSON„ÅÆÊßãÈÄ†ÂïèÈ°å„ÇíË©≥Á¥∞„Å´Ë®òÈå≤
                            if (parseError.message.includes('JSON')) {
                                console.error('JSON parse error at position:', parseError.message);
                                // ÊúÄÂàù„ÅÆ100ÊñáÂ≠ó„Å®ÊúÄÂæå„ÅÆ100ÊñáÂ≠ó„ÇíË°®Á§∫
                                if (jsonStr && jsonStr.length > 200) {
                                    console.error('JSON start:', jsonStr.substring(0, 100));
                                    console.error('JSON end:', jsonStr.substring(jsonStr.length - 100));
                                }
                            }
                            
                            if (retryCount < maxRetries - 1) {
                                console.log(`Retrying AI analysis (${retryCount + 2}/${maxRetries})...`);
                                showToast(`ÂàÜÊûê„ÇíÂÜçË©¶Ë°å‰∏≠... (${retryCount + 2}/${maxRetries})`, 'info');
                                retryCount++;
                                await new Promise(resolve => setTimeout(resolve, 1000)); // 1ÁßíÂæÖÊ©ü
                            } else {
                                throw parseError;
                            }
                        }
                        
                    } catch (error) {
                        lastError = error;
                        retryCount++;
                        
                        if (retryCount >= maxRetries) {
                            console.error('All analysis attempts failed:', error);
                            showToast('AIÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãïÂàÜÊûê„Çí‰ΩøÁî®„Åó„Åæ„Åô', 'warning');
                            
                            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÊâãÂãïÂàÜÊûê„Çí‰ΩøÁî®
                            const manualAnalysis = generateDetailedAnalysis();
                            setAiAnalysis({
                                ...manualAnalysis,
                                overallFeedback: 'Ëá™ÂãïÂàÜÊûê„Å´Â§±Êïó„Åó„Åü„Åü„ÇÅ„ÄÅÂü∫Êú¨ÁöÑ„Å™ÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
                                fromManual: true
                            });
                            break;
                        }
                        
                        console.log(`Retrying due to API error (${retryCount + 1}/${maxRetries})...`);
                        await new Promise(resolve => setTimeout(resolve, 2000)); // 2ÁßíÂæÖÊ©ü
                    }
                }
                
                setIsTyping(false);
            }, [apiKey, apiModel, messages, persona, showToast, getAnalysisData, generateDetailedAnalysis, insights, bestQuestions]);
            
            // ÁµêÊûúÁîªÈù¢
            const renderResult = () => {
                // AIAnalysis„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞ÊâãÂãïÂàÜÊûê„Çí‰ΩøÁî®
                let analysis = aiAnalysis;
                
                // AIÂàÜÊûê„Åå‰∏çÂÆåÂÖ®„Å™Â†¥Âêà„ÅØÊâãÂãïÂàÜÊûê„ÅßË£úÂÆå
                if (!analysis || !analysis.stats) {
                    const manualAnalysis = generateDetailedAnalysis();
                    if (analysis) {
                        // AIÂàÜÊûê„ÅÆ‰∏ÄÈÉ®„Åå‰Ωø„Åà„ÇãÂ†¥Âêà„ÅØ„Éû„Éº„Ç∏ÔºàAIÂàÜÊûê„ÇíÂÑ™ÂÖàÔºâ
                        analysis = {
                            ...manualAnalysis,
                            ...analysis,
                            stats: analysis.stats || manualAnalysis.stats,
                            // ÈÖçÂàó„ÅØÁ¢∫ÂÆü„Å´Â≠òÂú®„Åô„Çã„Çà„ÅÜ„Å´„Åô„Çã
                            strengths: analysis.strengths || manualAnalysis.strengths || [],
                            improvements: analysis.improvements || manualAnalysis.improvements || [],
                            insights: analysis.insights || manualAnalysis.insights || [],
                            challenges: analysis.challenges || manualAnalysis.challenges || []
                        };
                    } else {
                        analysis = manualAnalysis;
                    }
                }
                
                // „Éá„Éº„Çø„ÅÆÊ§úË®º„Å®„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö
                analysis = {
                    ...analysis,
                    strengths: Array.isArray(analysis.strengths) ? analysis.strengths : [],
                    improvements: Array.isArray(analysis.improvements) ? analysis.improvements : [],
                    insights: Array.isArray(analysis.insights) ? analysis.insights : [],
                    challenges: Array.isArray(analysis.challenges) ? analysis.challenges : [],
                    stats: analysis.stats || { avgScore: 0, whyQuestions: 0, openQuestions: 0, avgLength: 0, totalInsights: 0 }
                };
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞
                console.log('Rendering analysis result:', {
                    hasStrengths: analysis.strengths && analysis.strengths.length > 0,
                    hasImprovements: analysis.improvements && analysis.improvements.length > 0,
                    hasInsights: analysis.insights && analysis.insights.length > 0,
                    hasChallenges: analysis.challenges && analysis.challenges.length > 0,
                    improvements: analysis.improvements
                });
                
                // insights„Å®bestQuestions„ÇíÂàÜÊûêÁµêÊûú„Åã„ÇâÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞state„Åã„ÇâÂèñÂæó
                const displayInsights = analysis.insights || insights;
                const displayBestQuestions = analysis.bestQuestion ? 
                    [{ question: analysis.bestQuestion.question, score: 90 }] : bestQuestions;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 p-4 overflow-y-auto">
                        <div className="max-w-6xl mx-auto space-y-6">
                            {/* „Çπ„Ç≥„Ç¢„Çµ„Éû„É™„Éº */}
                            <div className="bg-white rounded-2xl shadow-2xl p-8 fade-in">
                                <div className="text-center mb-8">
                                    <div className="text-6xl font-bold mb-4 gradient-text">
                                        {calculateRank()}
                                    </div>
                                    <div className="text-3xl font-bold mb-2">
                                        {currentScore} pts
                                    </div>
                                    <div className="text-gray-600">
                                        {questionCount}Âõû„ÅÆË≥™Âïè | Âπ≥Âùá„Çπ„Ç≥„Ç¢: {analysis.stats.avgScore}ÁÇπ
                                    </div>
                                </div>
                                
                                {/* Áµ±Ë®àÊÉÖÂ†± */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                                    <div className="text-center p-3 bg-purple-50 rounded-lg">
                                        <div className="text-2xl font-bold text-purple-600">{analysis.stats.whyQuestions}</div>
                                        <div className="text-xs text-gray-600">„Å™„ÅúË≥™Âïè</div>
                                    </div>
                                    <div className="text-center p-3 bg-blue-50 rounded-lg">
                                        <div className="text-2xl font-bold text-blue-600">{analysis.stats.openQuestions}</div>
                                        <div className="text-xs text-gray-600">„Ç™„Éº„Éó„É≥Ë≥™Âïè</div>
                                    </div>
                                    <div className="text-center p-3 bg-green-50 rounded-lg">
                                        <div className="text-2xl font-bold text-green-600">{analysis.stats.avgLength}</div>
                                        <div className="text-xs text-gray-600">Âπ≥ÂùáÊñáÂ≠óÊï∞</div>
                                    </div>
                                    <div className="text-center p-3 bg-yellow-50 rounded-lg">
                                        <div className="text-2xl font-bold text-yellow-600">{analysis.stats.totalInsights}</div>
                                        <div className="text-xs text-gray-600">„Ç§„É≥„Çµ„Ç§„Éà</div>
                                    </div>
                                    <div className="text-center p-3 bg-pink-50 rounded-lg">
                                        <div className="text-2xl font-bold text-pink-600">{bestQuestions.length}</div>
                                        <div className="text-xs text-gray-600">ÂÑ™ÁßÄË≥™Âïè</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* „Éô„Çπ„ÉàË≥™Âïè„Å®„Ç§„É≥„Çµ„Ç§„Éà */}
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center">
                                        <span className="text-2xl mr-2">üèÜ</span>
                                        „Éô„Çπ„ÉàË≥™Âïè TOP3
                                    </h3>
                                    <div className="space-y-3">
                                        {displayBestQuestions.slice(0, 3).map((q, i) => (
                                            <div key={i} className="p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-lg font-bold text-purple-600">#{i + 1}</span>
                                                    <span className="font-bold text-purple-600">{q.score}pts</span>
                                                </div>
                                                <div className="text-sm text-gray-700">{q.question}</div>
                                            </div>
                                        ))}
                                        {displayBestQuestions.length === 0 && (
                                            <div className="text-gray-500 text-center py-4">„Åæ„Å†È´òÂæóÁÇπ„ÅÆË≥™Âïè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h3 className="font-bold text-lg mb-4 flex items-center">
                                        <span className="text-2xl mr-2">üí°</span>
                                        Áô∫Ë¶ã„Åó„Åü„Ç§„É≥„Çµ„Ç§„Éà
                                    </h3>
                                    <div className="space-y-3">
                                        {displayInsights.map((insight, i) => (
                                            <div key={i} className="p-3 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg">
                                                <div className="text-sm text-gray-700">{insight}</div>
                                            </div>
                                        ))}
                                        {displayInsights.length === 0 && (
                                            <div className="text-gray-500 text-center py-4">
                                                „Ç§„É≥„Çµ„Ç§„Éà„ÇíÁô∫Ë¶ã„Åô„Çã„Å´„ÅØ„ÄÅ„Çà„ÇäÊ∑±„ÅÑ„Äå„Å™„Åú„Äç„ÅÆË≥™Âïè„ÅåÂøÖË¶Å„Åß„Åô
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Ë©≥Á¥∞ÂàÜÊûê */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <h3 className="font-bold text-xl mb-6 text-center">üìä Ë©≥Á¥∞„Å™ÂàÜÊûê„Å®„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h3>
                                
                                {/* Âº∑„Åø */}
                                {analysis.strengths && analysis.strengths.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-green-600">‚ú® „ÅÇ„Å™„Åü„ÅÆÂº∑„Åø</h4>
                                        <div className="space-y-3">
                                            {analysis.strengths.map((strength, i) => (
                                                <div key={i} className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                                                    <div className="font-bold text-green-700 mb-1">{strength.title}</div>
                                                    <div className="text-sm text-gray-700">{strength.detail}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* „Éô„Çπ„ÉàË≥™Âïè„Å®„ÉØ„Éº„Çπ„ÉàË≥™Âïè */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {analysis.bestQuestion && (
                                        <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                                            <h5 className="font-bold text-blue-700 mb-2">üèÜ ÊúÄ„ÇÇÂÑ™„Çå„ÅüË≥™Âïè</h5>
                                            <div className="text-sm text-gray-700 italic mb-2">„Äå{analysis.bestQuestion.question}„Äç</div>
                                            <div className="text-xs text-gray-600">{analysis.bestQuestion.reason}</div>
                                        </div>
                                    )}
                                    {analysis.worstQuestion && (
                                        <div className="p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                                            <h5 className="font-bold text-red-700 mb-2">üí≠ ÊîπÂñÑ„ÅåÂøÖË¶Å„Å™Ë≥™Âïè</h5>
                                            <div className="text-sm text-gray-700 italic mb-2">„Äå{analysis.worstQuestion.question}„Äç</div>
                                            <div className="text-xs text-gray-600">{analysis.worstQuestion.improvement}</div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* ÊîπÂñÑÁÇπ */}
                                {analysis.improvements && analysis.improvements.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-orange-600">üìà ÊîπÂñÑ„Éù„Ç§„É≥„Éà</h4>
                                        <div className="space-y-3">
                                            {analysis.improvements.map((improvement, i) => (
                                                <div key={i} className="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                                    <div className="font-bold text-orange-700 mb-1">{improvement.title}</div>
                                                    <div className="text-sm text-gray-700 mb-2">{improvement.detail}</div>
                                                    {improvement.practice && (
                                                        <div className="p-3 bg-white rounded-md">
                                                            <div className="text-xs font-bold text-orange-600 mb-1">üí™ Á∑¥ÁøíÊñπÊ≥ï</div>
                                                            <div className="text-xs text-gray-600">{improvement.practice}</div>
                                                            {improvement.examples && improvement.examples.length > 0 && (
                                                                <div className="mt-2">
                                                                    <div className="text-xs font-bold text-orange-600 mb-1">üìù Ë≥™Âïè‰æã</div>
                                                                    <div className="space-y-1">
                                                                        {improvement.examples.map((example, i) => (
                                                                            <div key={i} className="text-xs text-gray-600 pl-2">
                                                                                {example}
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* ËÅû„ÅçÈÄÉ„Åó„ÅüÊ©ü‰ºö */}
                                {analysis.missedOpportunities && analysis.missedOpportunities.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-yellow-600">‚ö†Ô∏è ËÅû„ÅçÈÄÉ„Åó„ÅüÈáçË¶Å„Å™Ê©ü‰ºö</h4>
                                        <div className="space-y-3">
                                            {analysis.missedOpportunities.map((opportunity, i) => (
                                                <div key={i} className="p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                                    <div className="font-bold text-yellow-700 mb-1">Áû¨Èñì: {opportunity.moment}</div>
                                                    <div className="text-sm text-gray-700 mb-1">ËÅû„Åè„Åπ„Åç„Å†„Å£„ÅüË≥™Âïè: „Äå{opportunity.whatToAsk}„Äç</div>
                                                    <div className="text-xs text-gray-600">ÁêÜÁî±: {opportunity.reason}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* ÊÑüÊÉÖÁü•ÊÄßË©ï‰æ° */}
                                {analysis.emotionalIntelligence && (
                                    <div className="mb-6 p-4 bg-pink-50 rounded-lg border-l-4 border-pink-500">
                                        <h4 className="font-bold text-pink-700 mb-2">üíó ÊÑüÊÉÖ„Å∏„ÅÆÈÖçÊÖÆ„Çπ„Ç≥„Ç¢: {analysis.emotionalIntelligence.score}/100</h4>
                                        <div className="text-sm text-gray-700">{analysis.emotionalIntelligence.feedback}</div>
                                    </div>
                                )}
                                
                                {/* Ë≥™ÂïèÊäÄË°ì„ÅÆË©≥Á¥∞Ë©ï‰æ° */}
                                {analysis.questioningTechniques && (
                                    <div className="mb-6">
                                        <h4 className="font-bold text-lg mb-3 text-teal-600">üéØ Ë≥™ÂïèÊäÄË°ì„ÅÆË©≥Á¥∞Ë©ï‰æ°</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">„Ç™„Éº„Éó„É≥Ë≥™Âïè</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.openQuestions}</div>
                                            </div>
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„Éó</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.followUp}</div>
                                            </div>
                                            <div className="p-3 bg-teal-50 rounded-lg">
                                                <div className="font-bold text-teal-700 text-sm mb-1">Ê∑±Êéò„ÇäÂäõ</div>
                                                <div className="text-xs text-gray-600">{analysis.questioningTechniques.probing}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Á∑èÂêà„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */}
                                {analysis.overallFeedback && (
                                    <div className="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border-l-4 border-indigo-500">
                                        <h4 className="font-bold text-indigo-700 mb-2">üí° Á∑èÂêà„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h4>
                                        <div className="text-sm text-gray-700">{analysis.overallFeedback}</div>
                                    </div>
                                )}
                                
                                {/* Ê¨°Âõû„ÅÆË™≤È°å */}
                                {analysis.challenges && analysis.challenges.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-lg mb-3 text-purple-600">üéØ Ê¨°Âõû„ÉÅ„É£„É¨„É≥„Ç∏„Åô„ÇãË™≤È°å</h4>
                                    <div className="space-y-3">
                                        {analysis.challenges.map((challenge, i) => (
                                            <div key={i} className="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                                                <div className="font-bold text-purple-700 mb-1">{challenge.title}</div>
                                                <div className="text-sm text-gray-700">{challenge.approach}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                )}
                            </div>
                            
                            {/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="flex gap-3">
                                    <button
                                        onClick={resetGame}
                                        className="flex-1 py-3 px-6 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors"
                                    >
                                        „É°„Éã„É•„Éº„Å´Êàª„Çã
                                    </button>
                                    <button
                                        onClick={() => {
                                            const text = `„Éá„Ç∂„Ç§„É≥ÊÄùËÄÉ„Ç§„É≥„Çø„Éì„É•„Éº„Ç≤„Éº„É†
„É©„É≥„ÇØ: ${calculateRank()}
Á∑èÂêà„Çπ„Ç≥„Ç¢: ${currentScore}pts
Âπ≥Âùá: ${analysis.stats.avgScore}ÁÇπ/Ë≥™Âïè
„Å™„ÅúË≥™Âïè: ${analysis.stats.whyQuestions}Âõû
„Ç™„Éº„Éó„É≥Ë≥™Âïè: ${analysis.stats.openQuestions}Âõû`;
                                            if (navigator.share) {
                                                navigator.share({
                                                    title: '„Ç§„É≥„Çø„Éì„É•„Éº„Ç≤„Éº„É†ÁµêÊûú',
                                                    text: text
                                                });
                                            } else {
                                                navigator.clipboard.writeText(text);
                                                showToast('ÁµêÊûú„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                                            }
                                        }}
                                        className="flex-1 py-3 px-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105"
                                    >
                                        ÁµêÊûú„Çí„Ç∑„Çß„Ç¢
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };
            
            // „Éö„É´„ÇΩ„ÉäÁ¢∫Ë™çÁîªÈù¢
            const renderPersona = () => (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-100 to-pink-100">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full fade-in">
                        <h2 className="text-2xl font-bold text-center mb-6 gradient-text">
                            „Ç§„É≥„Çø„Éì„É•„ÉºÁõ∏Êâã„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´
                        </h2>
                        
                        {persona && (
                            <div className="space-y-6">
                                {/* Âü∫Êú¨ÊÉÖÂ†±„Ç´„Éº„Éâ */}
                                <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6">
                                    <div className="flex items-center mb-4">
                                        <div className="w-20 h-20 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                            {persona.name.charAt(0)}
                                        </div>
                                        <div className="ml-4">
                                            <h3 className="text-2xl font-bold text-gray-800">{persona.name}</h3>
                                            <p className="text-gray-600">{persona.age}Ê≠≥ / {persona.gender}</p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">ËÅ∑Ê•≠</div>
                                            <div className="font-medium text-gray-800">{persona.job}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">Â±Ö‰ΩèÂú∞</div>
                                            <div className="font-medium text-gray-800">{persona.location}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">ÂÆ∂ÊóèÊßãÊàê</div>
                                            <div className="font-medium text-gray-800">{persona.family}</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-3">
                                            <div className="text-xs text-gray-500 mb-1">Ë∂£Âë≥</div>
                                            <div className="font-medium text-gray-800">{persona.hobbies.join('„ÄÅ')}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* „Ç§„É≥„Çø„Éì„É•„Éº„ÉÜ„Éº„Éû */}
                                <div className="bg-blue-50 rounded-xl p-4">
                                    <h4 className="font-bold text-blue-800 mb-2">‰ªäÂõû„ÅÆ„Ç§„É≥„Çø„Éì„É•„Éº„ÉÜ„Éº„Éû</h4>
                                    <p className="text-gray-700 text-lg">{persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'Âõ∞„Çä„Åî„Å®'}</p>
                                </div>
                                
                                {/* ËÉåÊôØÊÉÖÂ†±ÔºàAIÁîüÊàê„ÅÆÂ†¥ÂêàÔºâ */}
                                {(persona.background || persona.currentSituation) && (
                                    <div className="bg-green-50 rounded-xl p-4">
                                        <h4 className="font-bold text-green-800 mb-2">üìñ ‰∫∫Áâ©ËÉåÊôØ</h4>
                                        {persona.background && (
                                            <p className="text-sm text-gray-700 mb-2">{persona.background}</p>
                                        )}
                                        {persona.currentSituation && (
                                            <p className="text-sm text-gray-700">{persona.currentSituation}</p>
                                        )}
                                        {persona.personality?.traits && persona.personality.traits.length > 0 && (
                                            <div className="mt-2 pt-2 border-t border-green-200">
                                                <span className="text-xs font-bold text-green-700">ÊÄßÊ†ºÁâπÊÄß: </span>
                                                <span className="text-xs text-gray-600">{persona.personality.traits.join('„ÄÅ')}</span>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* „Éí„É≥„Éà */}
                                <div className="bg-yellow-50 rounded-xl p-4">
                                    <h4 className="font-bold text-yellow-800 mb-2">üí° „Ç§„É≥„Çø„Éì„É•„Éº„ÅÆ„Éí„É≥„Éà</h4>
                                    <ul className="text-sm text-gray-700 space-y-1">
                                        <li>‚Ä¢ Áõ∏Êâã„ÅÆËÉåÊôØ„ÇíÊÑèË≠ò„Åó„Å¶Ë≥™Âïè„Åó„Åæ„Åó„Çá„ÅÜ</li>
                                        <li>‚Ä¢ {persona.age}Ê≠≥„ÅÆ{persona.gender}„Å®„Åó„Å¶„ÅÆË¶ñÁÇπ„ÇíËÄÉÊÖÆ„Åó„Åæ„Åó„Çá„ÅÜ</li>
                                        <li>‚Ä¢ {persona.job}„Å®„ÅÑ„ÅÜËÅ∑Ê•≠ÁâπÊúâ„ÅÆË™≤È°å„Åå„ÅÇ„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì</li>
                                        <li>‚Ä¢ „Äå„Å™„Åú„Äç„ÇíÊ∑±Êéò„Çä„Åó„Å¶Êú¨Ë≥™ÁöÑ„Å™„Éã„Éº„Ç∫„ÇíÊé¢„Çä„Åæ„Åó„Çá„ÅÜ</li>
                                    </ul>
                                    
                                    {persona.painPoints && persona.painPoints.length > 0 && (
                                        <div className="mt-3 pt-3 border-t border-yellow-200">
                                            <div className="text-xs font-bold text-yellow-700 mb-1">
                                                üéØ „Åì„ÅÆ„ÉÜ„Éº„Éû„ÅßÊÉ≥ÂÆö„Åï„Çå„ÇãË™≤È°å
                                            </div>
                                            <div className="text-xs text-gray-600">
                                                {persona.painPoints.join('„ÄÅ')}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {persona.hiddenNeeds && persona.hiddenNeeds.length > 0 && (
                                        <div className="mt-2">
                                            <div className="text-xs font-bold text-yellow-700 mb-1">
                                                üîç Áô∫Ë¶ã„Åô„Åπ„ÅçÊΩúÂú®„Éã„Éº„Ç∫
                                            </div>
                                            <div className="text-xs text-gray-600">
                                                Ê∑±„ÅÑË≥™Âïè„ÅßË¶ã„Å§„Åë„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºà„Éí„É≥„Éà: {persona.hiddenNeeds.length}ÂÄãÔºâ
                                            </div>
                                        </div>
                                    )}
                                </div>
                                
                                {/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
                                <div className="flex gap-3">
                                    <button
                                        onClick={async () => {
                                            const finalPainPoint = customPainPoint || selectedPainPoint || 
                                                (persona.painPoints && persona.painPoints[0] ? persona.painPoints[0] : 'Âõ∞„Çä„Åî„Å®');
                                            setIsGeneratingPersona(true);
                                            try {
                                                const aiPersona = await generatePersonaWithAI(finalPainPoint);
                                                if (aiPersona) {
                                                    setPersona(aiPersona);
                                                } else {
                                                    setPersona(generatePersona(finalPainPoint));
                                                }
                                            } finally {
                                                setIsGeneratingPersona(false);
                                            }
                                        }}
                                        disabled={isGeneratingPersona}
                                        className={`flex-1 py-3 px-6 ${
                                            !isGeneratingPersona
                                                ? 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        } rounded-lg font-medium transition-colors`}
                                    >
                                        {isGeneratingPersona ? 'ÁîüÊàê‰∏≠...' : 'Âà•„ÅÆ‰∫∫„ÇíÈÅ∏„Å∂'}
                                    </button>
                                    <button
                                        onClick={startInterview}
                                        disabled={isGeneratingPersona}
                                        className={`flex-1 py-3 px-6 ${
                                            !isGeneratingPersona
                                                ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:from-purple-600 hover:to-pink-600 transform hover:scale-105'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        } rounded-lg font-medium transition-all`}
                                    >
                                        „Ç§„É≥„Çø„Éì„É•„Éº„ÇíÈñãÂßã
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
            
            return (
                <div className={`min-h-screen bg-gradient-to-br ${getMoodColor()} transition-all duration-1000`}>
                    {/* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ */}
                    {isGeneratingPersona && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-8 flex flex-col items-center">
                                <div className="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4"></div>
                                <div className="text-lg font-semibold text-gray-800">„Éö„É´„ÇΩ„Éä„ÇíÁîüÊàê‰∏≠...</div>
                                <div className="text-sm text-gray-600 mt-2">Â∞ë„Åó„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ</div>
                            </div>
                        </div>
                    )}
                    
                    {gameState === 'menu' && renderMenu()}
                    {gameState === 'persona' && renderPersona()}
                    {gameState === 'playing' && renderGame()}
                    {gameState === 'result' && renderResult()}
                    
                    {/* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà */}
                    {showParticles && (
                        <div className="fixed inset-0 pointer-events-none">
                            {[...Array(20)].map((_, i) => (
                                <div
                                    key={i}
                                    className="particle"
                                    style={{
                                        left: `${Math.random() * 100}%`,
                                        top: `${Math.random() * 100}%`,
                                        '--x': `${(Math.random() - 0.5) * 200}px`,
                                        '--y': `${(Math.random() - 0.5) * 200}px`,
                                        animationDelay: `${Math.random() * 0.5}s`
                                    }}
                                >
                                    ‚≠ê
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* „Éà„Éº„Çπ„ÉàÈÄöÁü• */}
                    <div className="fixed bottom-4 right-4 space-y-2 z-50">
                        {toasts.map(toast => (
                            <div
                                key={toast.id}
                                className={`toast ${
                                    toast.type === 'success' ? 'bg-green-500' :
                                    toast.type === 'warning' ? 'bg-yellow-500' :
                                    toast.type === 'error' ? 'bg-red-500' :
                                    'bg-gray-700'
                                } text-white px-4 py-2 rounded-lg shadow-lg`}
                            >
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InterviewGame />);
    </script>
</body>
</html>
